<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Valentine's Week 2026 ğŸ’œ</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

        body{
            font-family:'Georgia',serif;
            background:linear-gradient(135deg,#f5f1e8 0%,#e8dfd0 100%);
            min-height:100vh;
            display:flex;
            flex-direction:column;
            align-items:center;
            padding:20px;
            padding-bottom:60px;
            overflow-y:auto;
            -webkit-overflow-scrolling:touch;
        }

        .container{ max-width:500px; width:100%; text-align:center; position:relative; z-index:10; margin-top:10px; }

        h1{
            color:#6b4c8a;
            font-size:2rem;
            margin-bottom:10px;
            text-shadow:2px 2px 4px rgba(0,0,0,0.1);
        }

        .date-display{ color:#8b7aa8; font-size:1.2rem; margin-bottom:20px; font-style:italic; }

        .day-info{
            background:rgba(255,255,255,.8);
            border-radius:15px;
            padding:15px 20px;
            margin-bottom:20px;
            box-shadow:0 5px 15px rgba(107,76,138,.2);
        }
        .day-info h2{ color:#6b4c8a; font-size:1.4rem; margin-bottom:5px; }
        .day-emoji{ font-size:2.5rem; margin-bottom:10px; }

        .game-area{
            background:rgba(255,255,255,.6);
            border-radius:20px;
            padding:40px 20px;
            min-height:350px;
            position:relative;
            overflow:hidden;
            box-shadow:0 10px 30px rgba(107,76,138,.2);
            backdrop-filter:blur(10px);
        }

        .instruction{
            color:#6b4c8a;
            font-size:1.1rem;
            margin-bottom:20px;
            line-height:1.6;
            padding:0 10px;
        }
        .message{
            color:#8b7aa8;
            font-size:1rem;
            margin-top:20px;
            min-height:30px;
            font-style:italic;
        }
        .success-message{
            color:#6b4c8a;
            font-size:1.3rem;
            font-weight:bold;
            animation:fadeInScale .5s ease;
        }
        @keyframes fadeInScale{ from{opacity:0; transform:scale(.8);} to{opacity:1; transform:scale(1);} }

        .sprite{
            position:absolute;
            font-size:4rem;
            cursor:pointer;
            user-select:none;
            transition:transform .2s;
            filter:drop-shadow(0 4px 8px rgba(0,0,0,.2));
        }
        .sprite:active{ transform:scale(.9); }

        .particle{ position:absolute; pointer-events:none; font-size:1.5rem; }
        .confetti{ position:absolute; width:10px; height:10px; pointer-events:none; }

        .not-yet-message{ color:#8b7aa8; font-size:1.2rem; margin-top:80px; line-height:1.8; }
        .countdown{ font-size:1.5rem; color:#6b4c8a; margin-top:20px; }
        .completed-badge{
            background:#d4c5b9; color:#6b4c8a;
            padding:8px 16px;
            border-radius:20px;
            font-size:.9rem;
            display:inline-block;
            margin-top:10px;
        }

        /* Chocolate scratch */
        .chocolate-stage{
            position:absolute;
            inset:0;
            border-radius:20px;
            overflow:hidden;
            touch-action:none;
        }
        .chocolate-layer{
            position:absolute;
            inset:0;
            width:100%;
            height:100%;
            display:block;
        }
        .choco-center{
            position:absolute;
            left:50%;
            top:50%;
            transform:translate(-50%,-50%);
            z-index:5;
            pointer-events:none;
        }
        .choco-float{
            font-size:5rem;
            filter:drop-shadow(0 8px 18px rgba(0,0,0,.3));
            animation:chocoFloat 2s ease-in-out infinite;
            pointer-events:auto;
            cursor:pointer;
            user-select:none;
        }
        @keyframes chocoFloat{
            0%,100%{ transform:translateY(0); }
            50%{ transform:translateY(-18px); }
        }

        @keyframes spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
        @keyframes heartbeat{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.2);} }
        @keyframes bounce{ 0%,100%{transform:translateY(0);} 50%{transform:translateY(-30px);} }
    </style>
</head>

<body>
    <div class="container">
        <h1>Valentine's Week 2026</h1>
        <div class="date-display" id="dateDisplay"></div>

        <div class="game-area" id="gameArea">
            <div class="instruction">Loading...</div>
        </div>
    </div>

    <script>
        /* =========================
           MODE + STORAGE
        ========================== */
        const TEST_MODE = false;
        const STORAGE_KEY = 'valentineCollected2026';

        /* =========================
           DAYS (IDENTICAL to TEST)
        ========================== */
        const days = [
            { date:new Date('2026-02-07'), name:"Rose Day", emoji:"ğŸŒ¹", instruction:"Find the rose!", challenge:"colorChange", messages:{ success:"Happy Rose Day babe! â¤ï¸" } },
            { date:new Date('2026-02-08'), name:"Propose Day", emoji:"ğŸ’", instruction:"", challenge:"runAway", messages:{ success:"Together forever! ğŸ’" } },
            { date:new Date('2026-02-09'), name:"Chocolate Day", emoji:"ğŸ«", instruction:"", challenge:"chocolateSwipe", messages:{
                melting:"",
                secondLayer:"",
                finalLayer:"",
                tapChocolate:"",
                success:"Happy Chocolate Day babe! â¤ï¸"
            }},
            { date:new Date('2026-02-10'), name:"Teddy Day", emoji:"ğŸ§¸", instruction:"The teddy is shy! Catch it when it peeks out!", challenge:"peekaboo", messages:{ hiding:"Peek-a-boo!", success:"You found me! Happy Teddy Day babe ğŸ’— ğŸ§¸" } },
            { date:new Date('2026-02-11'), name:"Promise Day", emoji:"ğŸ¤", instruction:"Tap the handshake 3 times to seal the promise!", challenge:"threeTaps", messages:{ first:"", second:"", third:"", success:"" } },
            { date:new Date('2026-02-12'), name:"Hug Day", emoji:"ğŸ¤—", instruction:"Tap both hearts to bring them together!", challenge:"simultaneous", messages:{ waiting:"", miss:"", success:"" } },
            { date:new Date('2026-02-13'), name:"Kiss Day", emoji:"ğŸ’‹", instruction:"Quick! Catch the fleeting kiss!", challenge:"fleeting", messages:{ miss:"*mwah* Missed!", appearing:"Quick, while the moment lasts!", success:"Caught that kiss! ğŸ’‹" } },
            { date:new Date('2026-02-14'), name:"Valentine's Day", emoji:"â¤ï¸", instruction:"Collect all the love!", challenge:"finale", messages:{ collecting:"The whole week in one moment!", success:"Love conquers all... challenges! â¤ï¸" } }
        ];

        let gameState = { collected: JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') };
        function saveProgress(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState.collected)); }

        function showMessage(text){
            const el=document.getElementById('message');
            if(el){ el.textContent=text; el.className='message'; }
        }
        function showSuccessMessage(text){
            const el=document.getElementById('message');
            if(el){ el.textContent=text; el.className='message success-message'; }
        }

        function createParticles(x,y){
            const gameArea=document.getElementById('gameArea');
            const colors=['#6b4c8a','#8b7aa8','#d4c5b9','#f5f1e8','#ffd700'];
            for(let i=0;i<30;i++){
                const p=document.createElement('div');
                p.className='confetti';
                p.style.left=x+'px'; p.style.top=y+'px';
                p.style.background=colors[Math.floor(Math.random()*colors.length)];
                const a=(Math.PI*2*i)/30;
                const v=50+Math.random()*100;
                const tx=Math.cos(a)*v, ty=Math.sin(a)*v;
                gameArea.appendChild(p);
                p.animate([
                    {transform:'translate(0,0) rotate(0deg)',opacity:1},
                    {transform:`translate(${tx}px,${ty}px) rotate(${Math.random()*720}deg)`,opacity:0}
                ],{duration:1000+Math.random()*500,easing:'cubic-bezier(0,.9,.57,1)'}).onfinish=()=>p.remove();
            }
        }

        function createHearts(x,y){
            const gameArea=document.getElementById('gameArea');
            const hearts=['ğŸ’œ','ğŸ’—','ğŸ’–','âœ¨','ğŸŒŸ'];
            for(let i=0;i<15;i++){
                const h=document.createElement('div');
                h.className='particle';
                h.textContent=hearts[Math.floor(Math.random()*hearts.length)];
                h.style.left=x+'px'; h.style.top=y+'px';
                gameArea.appendChild(h);
                const tx=(Math.random()-0.5)*200;
                const ty=-100-Math.random()*100;
                h.animate([
                    {transform:'translate(0,0) scale(1)',opacity:1},
                    {transform:`translate(${tx}px,${ty}px) scale(0.5)`,opacity:0}
                ],{duration:1500,easing:'ease-out'}).onfinish=()=>h.remove();
            }
        }

        function collectSprite(dayIndex, x=null, y=null){
            if(!gameState.collected.includes(dayIndex)){
                gameState.collected.push(dayIndex);
                saveProgress();
            }
            showSuccessMessage(days[dayIndex].messages.success);
            setTimeout(()=>{
                document.getElementById('gameArea').innerHTML =
                    `<div class="instruction">Great job! ğŸ‰</div>
                     <div class="message">Come back tomorrow for the next challenge!</div>`;
            },2200);
        }

        function finalizeChallenge(dayIndex, html){
            if(!gameState.collected.includes(dayIndex)){
                gameState.collected.push(dayIndex);
                saveProgress();
            }
            document.getElementById('gameArea').innerHTML = html;
        }

        /* ========= GAME CODE (IDENTICAL to TEST) ========= */
        /* ROSE */
        function startColorChange(dayIndex){ /* same as test */
            const gameArea=document.getElementById('gameArea');
            gameArea.replaceWith(gameArea.cloneNode(false));
            const freshArea=document.getElementById('gameArea');
            let introStage=0;

            freshArea.innerHTML =
                '<div class="instruction" id="instruction" style="font-size:1.8rem;margin-top:100px;">Happy Rose Day! ğŸŒ¹</div>' +
                '<div class="message" id="message"></div>';

            function handleIntroTap(){
                introStage++;
                if(introStage===1){
                    const inst=document.getElementById('instruction');
                    inst.textContent="But where's your rose?";
                    inst.style.fontSize='1.5rem';
                    inst.style.marginTop='0';
                }else if(introStage===2){
                    freshArea.removeEventListener('click', handleIntroTap);
                    startEmojiGame();
                }
            }
            freshArea.addEventListener('click', handleIntroTap);

            function startEmojiGame(){
                const emojis=[
                    'â˜€ï¸','ğŸ§¸','ğŸ•','ğŸŒˆ','â­','ğŸŒ»','ğŸ€','ğŸŒ¸','ğŸ±','ğŸ¦','ğŸº','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯',
                    'ğŸ¦…','ğŸ¦‰','ğŸ¢','ğŸ¬','ğŸ‹','ğŸŒ','ğŸ—ºï¸','â›°ï¸','ğŸŒ‹','ğŸ”ï¸','ğŸŒ²','ğŸŒ³','ğŸŒ´','ğŸŒµ','ğŸ','ğŸ‚',
                    'ğŸŒ¾','ğŸŒ¿','â˜˜ï¸','ğŸ’','ğŸ”¥','ğŸ’§','â„ï¸','âš¡','ğŸŒ™','â˜ï¸','ğŸŒŠ','ğŸµï¸','ğŸŒ·','ğŸŒ¼','ğŸª»','âš“',
                    'ğŸ§­','â™ ï¸','â™£ï¸','â™¥ï¸','â™¦ï¸','â˜¯ï¸','â­•','âœ³ï¸','â‡ï¸','ğŸ”¶','ğŸ”·'
                ];

                const totalEmojis=240;
                let timerStarted=false;
                let timeLeft=30;
                let timerInterval=null;
                let emojiElements=[];
                let roseMessageShown=false;
                let removedCount=0;

                freshArea.innerHTML='';
                freshArea.style.position='relative';
                freshArea.style.overflow='hidden';
                freshArea.style.touchAction='none';

                const header=document.createElement('div');
                header.style.cssText='position:relative;z-index:1001;padding:10px;text-align:center;';
                header.innerHTML='<div class="instruction" id="instruction">But where\\\'s your rose?</div><div class="message" id="message"></div>';
                freshArea.appendChild(header);

                const emojiContainer=document.createElement('div');
                emojiContainer.id='emojiContainer';
                emojiContainer.style.cssText='position:absolute;top:80px;left:0;right:0;bottom:0;overflow:hidden;';
                freshArea.appendChild(emojiContainer);

                const containerHeight=freshArea.offsetHeight-80;
                const containerWidth=freshArea.offsetWidth;

                const rose=document.createElement('div');
                rose.style.cssText='position:absolute;font-size:4rem;z-index:9999;cursor:pointer;transition:all 0.5s;pointer-events:auto;user-select:none;';
                rose.style.left=(20+Math.random()*50)+'%';
                rose.style.top=(20+Math.random()*50)+'%';
                rose.textContent='ğŸŒ¹';
                emojiContainer.appendChild(rose);

                for(let i=0;i<totalEmojis;i++){
                    const emoji=document.createElement('div');
                    const size=1.5+Math.random()*1.5;
                    emoji.style.cssText=`position:absolute;font-size:${size}rem;pointer-events:none;transition:all 0.4s ease-out;user-select:none;`;
                    emoji.style.left=(Math.random()*85)+'%';
                    emoji.style.top=(Math.random()*85)+'%';
                    emoji.style.zIndex=10+Math.floor(i/20);
                    emoji.textContent=emojis[Math.floor(Math.random()*emojis.length)];
                    emojiContainer.appendChild(emoji);
                    emojiElements.push(emoji);
                }
                emojiElements.sort(()=>Math.random()-0.5);

                function getRemovalCount(){
                    const timeRatio=1-(timeLeft/30);
                    if(timeRatio<0.3) return 1;
                    if(timeRatio<0.5) return Math.random()<0.7?1:2;
                    if(timeRatio<0.65) return 2+Math.floor(Math.random()*2);
                    if(timeRatio<0.8) return 5+Math.floor(Math.random()*3);
                    return 12+Math.floor(Math.random()*8);
                }

                function checkAllEmojisGone(){
                    for(let i=0;i<emojiElements.length;i++){
                        if(emojiElements[i].style.opacity!=='0') return false;
                    }
                    return true;
                }

                function removeEmojis(x,y){
                    const count=getRemovalCount();
                    let removed=0;

                    for(let i=0;i<emojiElements.length && removed<count;i++){
                        const emoji=emojiElements[i];
                        if(emoji.style.opacity!=='0'){
                            const rect=emoji.getBoundingClientRect();
                            const containerRect=emojiContainer.getBoundingClientRect();
                            const emojiX=rect.left-containerRect.left;
                            const emojiY=rect.top-containerRect.top;

                            const angle=Math.atan2(emojiY-y, emojiX-x);
                            const distance=200+Math.random()*100;
                            const newX=Math.cos(angle)*distance;
                            const newY=Math.sin(angle)*distance;

                            emoji.style.transform=`translate(${newX}px, ${newY}px) rotate(${Math.random()*360}deg)`;
                            emoji.style.opacity='0';
                            removed++; removedCount++;
                        }
                    }

                    if(removedCount>=totalEmojis-10){
                        rose.style.transform='scale(1.3)';
                        rose.style.filter='drop-shadow(0 0 15px #ff69b4)';
                    }
                }

                let lastX=0,lastY=0;
                let isSwiping=false;

                function handleStart(e){
                    if(e.target===rose) return;
                    e.preventDefault();
                    const point=e.touches?e.touches[0]:e;
                    const containerRect=emojiContainer.getBoundingClientRect();
                    lastX=point.clientX-containerRect.left;
                    lastY=point.clientY-containerRect.top;
                    isSwiping=true;

                    if(!timerStarted){
                        timerStarted=true;
                        timerInterval=setInterval(()=>{
                            timeLeft--;
                            if(timeLeft<=5 && removedCount<totalEmojis-20){
                                removeEmojis(containerWidth/2, containerHeight/2);
                            }
                            if(timeLeft<=0){
                                clearInterval(timerInterval);
                                emojiElements.forEach(el=>el.style.opacity='0');
                                rose.style.transform='scale(1.5)';
                                rose.style.filter='drop-shadow(0 0 20px #ff69b4)';
                            }
                        },1000);
                    }
                }

                function handleMove(e){
                    if(!isSwiping) return;
                    e.preventDefault();
                    const point=e.touches?e.touches[0]:e;
                    const containerRect=emojiContainer.getBoundingClientRect();
                    const x=point.clientX-containerRect.left;
                    const y=point.clientY-containerRect.top;

                    const dist=Math.sqrt((x-lastX)**2+(y-lastY)**2);
                    if(dist>15){
                        removeEmojis(x,y);
                        lastX=x; lastY=y;
                    }
                }

                function handleEnd(){ isSwiping=false; }

                emojiContainer.addEventListener('mousedown', handleStart);
                emojiContainer.addEventListener('mousemove', handleMove);
                emojiContainer.addEventListener('mouseup', handleEnd);
                emojiContainer.addEventListener('mouseleave', handleEnd);
                emojiContainer.addEventListener('touchstart', handleStart, {passive:false});
                emojiContainer.addEventListener('touchmove', handleMove, {passive:false});
                emojiContainer.addEventListener('touchend', handleEnd);

                function endRoseDay(x,y){
                    if(timerInterval) clearInterval(timerInterval);
                    emojiContainer.remove();

                    createHearts(x,y);
                    createParticles(x,y);

                    const inst=document.getElementById('instruction');
                    inst.textContent='Happy Rose Day babe! â¤ï¸';
                    inst.style.fontSize='1.6rem';

                    const msg=document.getElementById('message');
                    if(msg) msg.textContent='';

                    setTimeout(()=>{
                        finalizeChallenge(dayIndex,
                            '<div class="instruction" style="font-size:1.6rem;">Happy Rose Day babe! â¤ï¸</div>' +
                            '<div class="message">Challenge cleared ğŸŒ¹</div>'
                        );
                    },1200);
                }

                function tryCollectRose(ev){
                    ev.preventDefault?.();
                    ev.stopPropagation();
                    if(roseMessageShown) return;
                    if(!checkAllEmojisGone()) return;
                    roseMessageShown=true;

                    const pt=ev.touches?ev.touches[0]:(ev.changedTouches?ev.changedTouches[0]:ev);
                    endRoseDay(pt.clientX, pt.clientY);
                }

                rose.addEventListener('pointerup', tryCollectRose, {passive:false});
                rose.addEventListener('touchend', tryCollectRose, {passive:false});
            }
        }

        /* PROPOSE */
        function startRunAway(dayIndex){ /* same as test */
            const gameArea=document.getElementById('gameArea');
            gameArea.replaceWith(gameArea.cloneNode(false));
            const freshArea=document.getElementById('gameArea');

            freshArea.innerHTML='<div class="instruction" id="instruction"></div><div class="message" id="message"></div>';
            let stage=0;

            const guy=document.createElement('div');
            guy.className='sprite';
            guy.textContent='ğŸ™‡ğŸ½â€â™‚ï¸';
            guy.style.left='50%';
            guy.style.top='50%';
            guy.style.transform='translate(-50%,-50%)';
            freshArea.appendChild(guy);

            const bubble=document.createElement('div');
            bubble.style.cssText='position:absolute;background:white;padding:10px 15px;border-radius:15px;box-shadow:0 2px 10px rgba(0,0,0,0.2);font-size:1.05rem;color:#6b4c8a;opacity:0;transition:opacity 0.15s;z-index:100;max-width:70%;text-align:center;pointer-events:none;';
            freshArea.appendChild(bubble);

            function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
            function showBubble(text,targetEl){
                bubble.innerHTML=text;
                bubble.style.opacity='1';
                const guyRect=targetEl.getBoundingClientRect();
                const areaRect=freshArea.getBoundingClientRect();

                bubble.style.left='0px';
                bubble.style.top='0px';
                bubble.style.transform='translateX(-50%)';

                const bubbleRect=bubble.getBoundingClientRect();
                let centerX=(guyRect.left-areaRect.left)+(guyRect.width/2);
                let topY=(guyRect.top-areaRect.top)-bubbleRect.height-10;
                if(topY<10) topY=(guyRect.bottom-areaRect.top)+10;

                centerX=clamp(centerX, bubbleRect.width/2+10, areaRect.width-bubbleRect.width/2-10);
                bubble.style.left=centerX+'px';
                bubble.style.top=topY+'px';
            }
            function hideBubble(){ bubble.style.opacity='0'; }

            function moveGuyRandom(){
                const areaRect=freshArea.getBoundingClientRect();
                const newX=50+Math.random()*(areaRect.width-150);
                const newY=90+Math.random()*(areaRect.height-210);
                guy.style.left=newX+'px';
                guy.style.top=newY+'px';
                guy.style.transform='translate(0,0)';
                if(bubble.style.opacity==='1') showBubble(bubble.innerHTML, guy);
            }

            let chaseCount=0;
            let tapCount=0;

            freshArea.addEventListener('click', function(e){
                if(e.target===freshArea && stage===2){
                    tapCount++;
                    if(tapCount>=3){
                        stage=3;
                        tapCount=0;
                        guy.style.opacity='1';
                        moveGuyRandom();
                    }
                }
            });

            function endProposeDay(x,y){
                createHearts(x,y);
                createParticles(x,y);

                const inst=document.getElementById('instruction');
                inst.innerHTML=
                    '<div style="text-align:center; line-height:1.25;">' +
                        '<div style="font-size:1.6rem; font-weight:bold;">Together forever! ğŸ’</div>' +
                        '<div style="font-size:1.25rem; margin-top:6px;">Happy Propose Day babe! â¤ï¸</div>' +
                        '<div style="font-size:1.25rem; margin-top:6px;">â˜€ï¸â˜€ï¸ğŸŒ»ğŸŒ»</div>' +
                    '</div>';

                const msg=document.getElementById('message');
                if(msg) msg.textContent='';

                setTimeout(()=>{
                    finalizeChallenge(dayIndex,
                        '<div class="instruction" style="font-size:1.5rem; line-height:1.3;">' +
                            '<div style="font-weight:bold;">Together forever! ğŸ’</div>' +
                            '<div style="margin-top:6px;">Happy Propose Day babe! â¤ï¸</div>' +
                            '<div style="margin-top:6px;">â˜€ï¸â˜€ï¸ğŸŒ»ğŸŒ»</div>' +
                        '</div>' +
                        '<div class="message">Challenge cleared ğŸ’œ</div>'
                    );
                },1400);
            }

            guy.addEventListener('click', function(e){
                e.stopPropagation();

                if(stage===0){
                    showBubble('Hi', guy);
                    stage=1;
                    setTimeout(()=>{
                        hideBubble();
                        setTimeout(()=>{ guy.style.opacity='0'; stage=2; },500);
                    },1200);

                }else if(stage===3){
                    showBubble('I was thinking....', guy);
                    stage=4;
                    setTimeout(()=>{
                        hideBubble();
                        setTimeout(()=>{
                            guy.style.opacity='0';
                            setTimeout(()=>{
                                guy.style.opacity='1';
                                moveGuyRandom();
                                stage=5;
                            },700);
                        },400);
                    },1600);

                }else if(stage===5){
                    chaseCount++;
                    if(chaseCount<5){
                        moveGuyRandom();
                        guy.style.transition='all 0.25s ease';
                    }else{
                        stage=6;
                        guy.style.left='50%';
                        guy.style.top='40%';
                        guy.style.transform='translate(-50%,-50%)';
                    }

                }else if(stage===6){
                    showBubble('Be mine? ğŸ’•', guy);
                    stage=7;

                    setTimeout(()=>{
                        const ring=document.createElement('div');
                        ring.className='sprite';
                        ring.textContent='ğŸ’';
                        ring.style.left='70%';
                        ring.style.top='50%';
                        ring.style.fontSize='3rem';
                        ring.style.animation='heartbeat 1s ease infinite';
                        freshArea.appendChild(ring);

                        ring.addEventListener('click', function(ev){
                            ev.stopPropagation();
                            hideBubble();
                            guy.remove();
                            ring.remove();

                            const couple=document.createElement('div');
                            couple.className='sprite';
                            couple.textContent='ğŸ‘«';
                            couple.style.left='50%';
                            couple.style.top='45%';
                            couple.style.transform='translate(-50%,-50%)';
                            couple.style.fontSize='5rem';
                            freshArea.appendChild(couple);

                            endProposeDay(ev.clientX, ev.clientY);
                        });
                    },900);
                }
            });
        }

        /* CHOCOLATE (same as test) */
        function startChocolateSwipe(dayIndex){
            const gameArea=document.getElementById('gameArea');
            const day=days[dayIndex];

            gameArea.innerHTML='<div class="instruction" id="instruction"></div><div class="message" id="message"></div>';
            const stage=document.createElement('div');
            stage.className='chocolate-stage';
            gameArea.appendChild(stage);

            const center=document.createElement('div');
            center.className='choco-center';
            stage.appendChild(center);

            const choc=document.createElement('div');
            choc.className='choco-float';
            choc.textContent='ğŸ«';
            choc.style.display='none';
            center.appendChild(choc);

            const prompts=[day.messages.melting, day.messages.secondLayer, day.messages.finalLayer];
            let layerIndex=0;

            function setPrompt(t){ showMessage(t); }

            const layerStyles=[
                {base:'#6a1b9a', type:'glaze'},
                {base:'#f9f9f6', type:'paper'},
                {base:'#c9a53a', type:'foil'}
            ];

            function drawTexture(ctx,w,h,style){
                ctx.fillStyle=style.base;
                ctx.fillRect(0,0,w,h);

                if(style.type==='glaze'){
                    const g=ctx.createLinearGradient(0,0,w,h);
                    g.addColorStop(0,'rgba(255,255,255,0.34)');
                    g.addColorStop(0.35,'rgba(255,255,255,0.06)');
                    g.addColorStop(0.62,'rgba(255,255,255,0.28)');
                    g.addColorStop(1,'rgba(255,255,255,0.08)');
                    ctx.fillStyle=g;
                    ctx.fillRect(0,0,w,h);
                }else if(style.type==='paper'){
                    ctx.strokeStyle='rgba(80,80,80,0.12)';
                    ctx.lineWidth=1;
                    for(let x=-h;x<w+h;x+=18){
                        ctx.beginPath();
                        ctx.moveTo(x,0);
                        ctx.lineTo(x+h,h);
                        ctx.stroke();
                    }
                }else{
                    const g=ctx.createLinearGradient(0,0,w,0);
                    g.addColorStop(0,'rgba(255,255,255,0.16)');
                    g.addColorStop(0.2,'rgba(255,255,255,0.38)');
                    g.addColorStop(0.5,'rgba(120,84,14,0.22)');
                    g.addColorStop(0.8,'rgba(255,255,255,0.28)');
                    g.addColorStop(1,'rgba(98,68,12,0.2)');
                    ctx.fillStyle=g;
                    ctx.fillRect(0,0,w,h);

                    ctx.strokeStyle='rgba(255,255,255,0.25)';
                    for(let y=0;y<h;y+=20){
                        ctx.beginPath();
                        ctx.moveTo(0, y+Math.random()*6);
                        ctx.lineTo(w, y+Math.random()*6);
                        ctx.stroke();
                    }
                }
            }

            function createLayer(style){
                const rect=stage.getBoundingClientRect();
                const dpr=window.devicePixelRatio||1;

                const canvas=document.createElement('canvas');
                canvas.className='chocolate-layer';
                canvas.width=Math.floor(rect.width*dpr);
                canvas.height=Math.floor(rect.height*dpr);
                canvas.style.width=rect.width+'px';
                canvas.style.height=rect.height+'px';

                const ctx=canvas.getContext('2d',{willReadFrequently:true});
                ctx.setTransform(dpr,0,0,dpr,0,0);
                drawTexture(ctx, rect.width, rect.height, style);
                stage.appendChild(canvas);

                const sample=document.createElement('canvas');
                sample.width=80; sample.height=80;
                const sctx=sample.getContext('2d',{willReadFrequently:true});

                const state={
                    canvas, ctx,
                    rectW: rect.width,
                    rectH: rect.height,
                    drawing:false,
                    last:null,
                    getClearedRatio: function(){
                        sctx.clearRect(0,0,sample.width,sample.height);
                        sctx.drawImage(canvas,0,0,sample.width,sample.height);
                        const data=sctx.getImageData(0,0,sample.width,sample.height).data;
                        let transparent=0;
                        for(let i=3;i<data.length;i+=4){
                            if(data[i]<18) transparent++;
                        }
                        return transparent/(sample.width*sample.height);
                    }
                };

                bindScratch(state);
                return state;
            }

            function bindScratch(layer){
                const brushSize=Math.max(60, Math.floor(layer.rectW*0.12));

                function toLocal(cx,cy){
                    const r=layer.canvas.getBoundingClientRect();
                    return { x: cx-r.left, y: cy-r.top };
                }

                function eraseLine(a,b){
                    layer.ctx.globalCompositeOperation='destination-out';
                    layer.ctx.lineCap='round';
                    layer.ctx.lineJoin='round';
                    layer.ctx.strokeStyle='rgba(0,0,0,1)';
                    layer.ctx.lineWidth=brushSize;
                    layer.ctx.beginPath();
                    layer.ctx.moveTo(a.x,a.y);
                    layer.ctx.lineTo(b.x,b.y);
                    layer.ctx.stroke();
                }

                function erasePoint(p){
                    layer.ctx.globalCompositeOperation='destination-out';
                    layer.ctx.beginPath();
                    layer.ctx.arc(p.x,p.y,brushSize*0.55,0,Math.PI*2);
                    layer.ctx.fill();
                }

                function down(e){
                    layer.drawing=true;
                    layer.last=null;
                    layer.canvas.setPointerCapture(e.pointerId);
                    const p=toLocal(e.clientX,e.clientY);
                    erasePoint(p);
                    layer.last=p;
                }

                function move(e){
                    if(!layer.drawing) return;
                    const p=toLocal(e.clientX,e.clientY);
                    if(layer.last) eraseLine(layer.last,p);
                    erasePoint(p);
                    layer.last=p;

                    if(layer.getClearedRatio()>0.92){
                        layer.drawing=false;
                        layer.canvas.remove();
                        layerIndex++;
                        if(layerIndex<3){
                            setPrompt(prompts[layerIndex]);
                            activeLayer=createLayer(layerStyles[layerIndex]);
                        }else{
                            setPrompt(day.messages.tapChocolate);
                            choc.style.display='block';
                            choc.onclick=function(ev){
                                createParticles(ev.clientX,ev.clientY);
                                collectSprite(dayIndex, ev.clientX, ev.clientY);
                            };
                        }
                    }
                }

                function up(e){
                    layer.drawing=false;
                    layer.last=null;
                    try{ layer.canvas.releasePointerCapture(e.pointerId); }catch{}
                }

                layer.canvas.addEventListener('pointerdown', down);
                layer.canvas.addEventListener('pointermove', move);
                layer.canvas.addEventListener('pointerup', up);
                layer.canvas.addEventListener('pointercancel', up);
            }

            setPrompt(day.messages.melting);
            let activeLayer=createLayer(layerStyles[layerIndex]);
        }

        /* teddy */
function startPeekaboo(dayIndex) {
    const gameArea = document.getElementById('gameArea');

    // Clean slate (no intro text)
    gameArea.innerHTML = '<div class="instruction" id="instruction"></div><div class="message" id="message"></div>';

    // Internal state
    let foundCount = 0;
    let currentSpot = null;
    let lastPeekTime = 0;
    let peekTimer = null;
    let peekEl = null;
    let pulseTimer = null;

    // Furniture setup (larger)
    const furnitureConfig = [
        { key: 'couch',  emoji: 'ğŸ›‹ï¸', left: '10%', top: '65%' },
        { key: 'bed',    emoji: 'ğŸ›ï¸', left: '65%', top: '65%' },
        { key: 'door',   emoji: 'ğŸšª', left: '10%', top: '10%' },
        { key: 'window', emoji: 'ğŸªŸ', left: '65%', top: '10%' }
    ];

    const furnitureEls = {};

    furnitureConfig.forEach(cfg => {
        const el = document.createElement('div');
        el.className = 'sprite';
        el.textContent = cfg.emoji;
        el.style.left = cfg.left;
        el.style.top = cfg.top;
        el.style.fontSize = '5rem'; // much larger
        el.style.transition = 'transform 0.25s ease';
        gameArea.appendChild(el);
        furnitureEls[cfg.key] = el;

        el.addEventListener('click', function (e) {
            e.stopPropagation();
            const now = Date.now();
            const isCorrect = (cfg.key === currentSpot) && (now - lastPeekTime <= 750); // harder

            if (!isCorrect) {
                el.style.transform = 'scale(1.15) rotate(-4deg)';
                setTimeout(() => { el.style.transform = ''; }, 200);
                showMessage('Not here! ğŸ‘€');
                return;
            }

            // Correct
            foundCount++;

            if (peekEl) {
                peekEl.remove();
                peekEl = null;
            }

            const teddy = document.createElement('div');
            teddy.className = 'sprite';
            teddy.textContent = 'ğŸ§¸';
            teddy.style.left = cfg.left;
            teddy.style.top = cfg.top;
            teddy.style.fontSize = '4.5rem';
            teddy.style.animation = 'bounce 0.5s ease';
            gameArea.appendChild(teddy);

            createHearts(e.clientX, e.clientY);

            setTimeout(() => teddy.remove(), 500);

            if (foundCount >= 3) {
                clearTimeout(peekTimer);
                clearInterval(pulseTimer);

                // remove all furniture
                Object.values(furnitureEls).forEach(el => el.remove());

                createParticles(e.clientX, e.clientY);
                showMessage('ğŸ’—ğŸ§¸');

                setTimeout(() => {
                    collectSprite(dayIndex);
                }, 700);
                return;
            }

            pickNewSpot();
        });
    });

    function pickNewSpot() {
        const keys = Object.keys(furnitureEls).filter(k => k !== currentSpot);
        currentSpot = keys[Math.floor(Math.random() * keys.length)];
        schedulePeek();
    }

    function schedulePeek() {
        clearTimeout(peekTimer);
        const delay = 2000 + Math.random() * 800;
        peekTimer = setTimeout(showPeek, delay);
    }

    function showPeek() {
        if (peekEl) {
            peekEl.remove();
            peekEl = null;
        }

        const spotEl = furnitureEls[currentSpot];
        const rect = spotEl.getBoundingClientRect();
        const areaRect = gameArea.getBoundingClientRect();

        peekEl = document.createElement('div');
        peekEl.textContent = 'ğŸ§¸';
        peekEl.style.position = 'absolute';
        peekEl.style.fontSize = '2.2rem';
        peekEl.style.left = (rect.left - areaRect.left + rect.width * 0.65) + 'px';
        peekEl.style.top = (rect.top - areaRect.top + rect.height * 0.25) + 'px';
        peekEl.style.opacity = '0';
        peekEl.style.transition = 'opacity 0.2s ease';
        gameArea.appendChild(peekEl);

        requestAnimationFrame(() => {
            peekEl.style.opacity = '1';
        });

        lastPeekTime = Date.now();

        // Hide faster
        setTimeout(() => {
            if (peekEl) {
                peekEl.style.opacity = '0';
                setTimeout(() => {
                    if (peekEl) {
                        peekEl.remove();
                        peekEl = null;
                    }
                }, 150);
            }
            schedulePeek();
        }, 500);
    }

    // Random single-furniture pulse (independent of teddy)
    pulseTimer = setInterval(() => {
        const keys = Object.keys(furnitureEls);
        if (!keys.length) return;
        const el = furnitureEls[keys[Math.floor(Math.random() * keys.length)]];
        el.style.transform = 'scale(1.15)';
        setTimeout(() => { el.style.transform = ''; }, 250);
    }, 1200 + Math.random() * 800);

    // Start
    pickNewSpot();
}



        /*PROMISE DAY*/

function startThreeTaps(dayIndex) {
    const gameArea = document.getElementById('gameArea');

    // Clean slate
    gameArea.innerHTML =
        '<div class="instruction" id="instruction"></div>' +
        '<div class="message" id="message"></div>';

    // Disable text selection aggressively (iOS-safe)
    gameArea.style.userSelect = 'none';
    gameArea.style.webkitUserSelect = 'none';
    gameArea.style.webkitTouchCallout = 'none';

    // Hands
    const leftHand = document.createElement('div');
    leftHand.className = 'sprite';
    leftHand.textContent = 'ğŸ«³ğŸ½';
    leftHand.style.left = '25%';
    leftHand.style.top = '40%';

    const rightHand = document.createElement('div');
    rightHand.className = 'sprite';
    rightHand.textContent = 'ğŸ«´ğŸ½';
    rightHand.style.left = '65%';
    rightHand.style.top = '40%';
    rightHand.style.transform = 'scaleX(-1)';

    gameArea.appendChild(leftHand);
    gameArea.appendChild(rightHand);

    // Hold control (circle, bottom-right)
    const holdPad = document.createElement('div');
    holdPad.style.cssText = `
        position:absolute;
        right:16px;
        bottom:16px;
        width:64px;
        height:64px;
        border-radius:50%;
        background:rgba(139,122,168,0.35);
        touch-action:none;
        user-select:none;
        -webkit-user-select:none;
        -webkit-touch-callout:none;
    `;
    gameArea.appendChild(holdPad);

    let moving = false;
    let vx1 = 0, vy1 = 0, vx2 = 0, vy2 = 0;
    let rafId = null;

    function randomVelocity() {
        const speed = 2 + Math.random() * 5; // slow â†’ fast randomness
        const angle = Math.random() * Math.PI * 2;
        return { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed };
    }

    function startMoving(e) {
        e.preventDefault();
        if (moving) return;
        moving = true;

        ({ x: vx1, y: vy1 } = randomVelocity());
        ({ x: vx2, y: vy2 } = randomVelocity());

        animate();
    }

    function stopMoving(e) {
        e.preventDefault();
        if (!moving) return;
        moving = false;
        cancelAnimationFrame(rafId);

        if (areStronglyOverlapping()) {
            completePromise(e.clientX, e.clientY);
        }
    }

    function animate() {
        if (!moving) return;

        moveSprite(leftHand, v => { vx1 = v.x; vy1 = v.y; }, vx1, vy1);
        moveSprite(rightHand, v => { vx2 = v.x; vy2 = v.y; }, vx2, vy2);

        // Random speed + direction changes
        if (Math.random() < 0.03) ({ x: vx1, y: vy1 } = randomVelocity());
        if (Math.random() < 0.03) ({ x: vx2, y: vy2 } = randomVelocity());

        rafId = requestAnimationFrame(animate);
    }

    function moveSprite(el, setV, vx, vy) {
        const area = gameArea.getBoundingClientRect();
        const r = el.getBoundingClientRect();

        let x = r.left - area.left + vx;
        let y = r.top - area.top + vy;

        if (x < 0 || x > area.width - r.width) vx *= -1;
        if (y < 0 || y > area.height - r.height) vy *= -1;

        setV({ x: vx, y: vy });

        el.style.left = (r.left - area.left + vx) + 'px';
        el.style.top = (r.top - area.top + vy) + 'px';
    }

    // Require strong overlap (â‰ˆ60% area intersection)
    function areStronglyOverlapping() {
        const r1 = leftHand.getBoundingClientRect();
        const r2 = rightHand.getBoundingClientRect();

        const xOverlap = Math.max(0, Math.min(r1.right, r2.right) - Math.max(r1.left, r2.left));
        const yOverlap = Math.max(0, Math.min(r1.bottom, r2.bottom) - Math.max(r1.top, r2.top));
        const overlapArea = xOverlap * yOverlap;

        const minArea = Math.min(r1.width * r1.height, r2.width * r2.height);
        return overlapArea > minArea * 0.6;
    }

    function completePromise(x, y) {
        leftHand.remove();
        rightHand.remove();
        holdPad.remove();

        const handshake = document.createElement('div');
        handshake.className = 'sprite';
        handshake.textContent = 'ğŸ¤ğŸ½';
        handshake.style.left = '50%';
        handshake.style.top = '45%';
        handshake.style.transform = 'translate(-50%, -50%)';
        handshake.style.fontSize = '4.5rem';
        handshake.style.animation = 'heartbeat 0.8s ease-in-out infinite';
        gameArea.appendChild(handshake);

        createHearts(x, y);
        createParticles(x, y);

        // Glow + pulse for 3s
        setTimeout(() => {
            handshake.remove();
            showMessage('Promise made! I got your back and you got mine. Happy Promise Day babe! ğŸ’—');

            setTimeout(() => {
                collectSprite(dayIndex, x, y);
            }, 5000);
        }, 3000);
    }

    // Pointer-safe handlers
    holdPad.addEventListener('pointerdown', startMoving);
    holdPad.addEventListener('pointerup', stopMoving);
    holdPad.addEventListener('pointerleave', stopMoving);
    holdPad.addEventListener('pointercancel', stopMoving);
}



        /*Other */
        function startSimultaneous(dayIndex){
            const gameArea=document.getElementById('gameArea');
            const day=days[dayIndex];
            gameArea.innerHTML='<div class="instruction" id="instruction">'+day.instruction+'</div><div class="message" id="message"></div>';

            const heart1=document.createElement('div');
            heart1.className='sprite';
            heart1.textContent='ğŸ’œ';
            heart1.style.left='20%';
            heart1.style.top='50%';

            const heart2=document.createElement('div');
            heart2.className='sprite';
            heart2.textContent='ğŸ’—';
            heart2.style.left='80%';
            heart2.style.top='50%';

            gameArea.appendChild(heart1);
            gameArea.appendChild(heart2);

            showMessage(day.messages.waiting);

            let tapped={heart1:false, heart2:false};
            let lastTapTime=0;

            function handleTap(name, e){
                tapped[name]=true;
                lastTapTime=Date.now();

                setTimeout(()=>{
                    if(Date.now()-lastTapTime>500) tapped={heart1:false, heart2:false};
                },500);

                if(tapped.heart1 && tapped.heart2){
                    createHearts(e.clientX,e.clientY);
                    heart1.style.animation='bounce 0.8s ease';
                    heart2.style.animation='bounce 0.8s ease';
                    setTimeout(()=>{ heart1.remove(); heart2.remove(); collectSprite(dayIndex, e.clientX, e.clientY); },800);
                }else{
                    showMessage(day.messages.miss);
                }
            }

            heart1.addEventListener('click', (e)=>handleTap('heart1', e));
            heart2.addEventListener('click', (e)=>handleTap('heart2', e));
        }

        function startFleeting(dayIndex){
            const gameArea=document.getElementById('gameArea');
            const day=days[dayIndex];
            gameArea.innerHTML='<div class="instruction" id="instruction">'+day.instruction+'</div><div class="message" id="message"></div>';

            function spawnKiss(){
                const rect=gameArea.getBoundingClientRect();
                const sprite=document.createElement('div');
                sprite.className='sprite';
                sprite.textContent=day.emoji;
                sprite.style.left=(Math.random()*(rect.width-80))+'px';
                sprite.style.top=(Math.random()*(rect.height-80))+'px';
                sprite.style.opacity='0';
                gameArea.appendChild(sprite);

                setTimeout(()=>{ sprite.style.opacity='1'; sprite.style.transition='opacity 0.3s'; },100);
                showMessage(day.messages.appearing);

                const disappear=setTimeout(()=>{
                    sprite.style.opacity='0';
                    setTimeout(()=>{
                        sprite.remove();
                        showMessage(day.messages.miss);
                        setTimeout(spawnKiss, 800);
                    },300);
                },1500);

                sprite.addEventListener('click', (e)=>{
                    clearTimeout(disappear);
                    createParticles(e.clientX,e.clientY);
                    sprite.style.animation='spin 0.5s ease';
                    setTimeout(()=>{ sprite.remove(); collectSprite(dayIndex, e.clientX, e.clientY); },500);
                });
            }

            spawnKiss();
        }

        function startFinale(dayIndex){
            const gameArea=document.getElementById('gameArea');
            const day=days[dayIndex];
            gameArea.innerHTML='<div class="instruction" id="instruction">'+day.instruction+'</div><div class="message" id="message"></div>';
            showMessage(day.messages.collecting);

            const allEmojis=days.map(d=>d.emoji);
            let collectedCount=0;

            allEmojis.forEach((emoji,index)=>{
                setTimeout(()=>{
                    const sprite=document.createElement('div');
                    sprite.className='sprite';
                    sprite.textContent=emoji;
                    const angle=(Math.PI*2*index)/allEmojis.length;
                    sprite.style.left=(50+Math.cos(angle)*30)+'%';
                    sprite.style.top=(50+Math.sin(angle)*30)+'%';
                    sprite.style.animation='chocoFloat 2s ease-in-out infinite';
                    sprite.style.animationDelay=(index*0.1)+'s';
                    gameArea.appendChild(sprite);

                    sprite.addEventListener('click', (e)=>{
                        collectedCount++;
                        createParticles(e.clientX,e.clientY);
                        sprite.remove();
                        if(collectedCount===allEmojis.length){
                            setTimeout(()=>collectSprite(dayIndex, e.clientX, e.clientY), 500);
                        }
                    });
                }, index*200);
            });
        }

        function startChallenge(dayIndex){
            const day=days[dayIndex];
            const gameArea=document.getElementById('gameArea');
            gameArea.innerHTML='<div class="instruction" id="instruction">'+(day.instruction||'')+'</div><div class="message" id="message"></div>';

            switch(day.challenge){
                case'colorChange': startColorChange(dayIndex); break;
                case'runAway': startRunAway(dayIndex); break;
                case'chocolateSwipe': startChocolateSwipe(dayIndex); break;
                case'peekaboo': startPeekaboo(dayIndex); break;
                case'threeTaps': startThreeTaps(dayIndex); break;
                case'simultaneous': startSimultaneous(dayIndex); break;
                case'fleeting': startFleeting(dayIndex); break;
                case'finale': startFinale(dayIndex); break;
            }
        }

        /* ========= PROD GATING UI ========= */
        function getTodaysDayIndex(){
            const now=new Date();
            const today=new Date(now.getFullYear(), now.getMonth(), now.getDate());

            for(let i=0;i<days.length;i++){
                const d=days[i].date;
                const compare=new Date(d.getFullYear(), d.getMonth(), d.getDate());
                if(today.getTime()===compare.getTime()) return i;
            }

            const first=days[0].date;
            const last=days[days.length-1].date;
            if(today < new Date(first.getFullYear(), first.getMonth(), first.getDate())) return -1;
            if(today > new Date(last.getFullYear(), last.getMonth(), last.getDate())) return -2;
            return -3;
        }

        function showNotYetMessage(){
            const gameArea=document.getElementById('gameArea');
            const firstDay=days[0].date;
            const daysUntil=Math.ceil((firstDay - new Date())/(1000*60*60*24));
            gameArea.innerHTML=
                '<div class="not-yet-message">ğŸ’œ Something special is coming... ğŸ’œ<br><br>Come back on February 7th!</div>' +
                '<div class="countdown">'+daysUntil+' day to go</div>';
        }

        function showWeekOverMessage(){
            const gameArea=document.getElementById('gameArea');
            const completedCount=gameState.collected.length;
            gameArea.innerHTML=
                '<div class="instruction" style="font-size:1.5rem;">' +
                    'Valentine\\\'s Week 2026 ğŸ’œ<br><br>' +
                    'Thank you for celebrating with me!<br><br>' +
                    'Challenges completed: '+completedCount+'/'+days.length +
                '</div>';
        }

        function showAlreadyCompleted(dayIndex){
            const gameArea=document.getElementById('gameArea');
            gameArea.innerHTML=
                '<div class="instruction" style="font-size:1.4rem;">' +
                    'You already completed today\\\'s challenge! ğŸ‰<br><br>' +
                    'Come back tomorrow for a new one!' +
                '</div>' +
                '<div class="completed-badge">âœ“ Completed</div>';
        }

        function init(){
            const now=new Date();
            document.getElementById('dateDisplay').textContent =
                now.toLocaleDateString('en-US',{weekday:'long', year:'numeric', month:'long', day:'numeric'});

            const todayIndex=getTodaysDayIndex();

            if(todayIndex===-1){
                document.getElementById('dayInfo').style.display='none';
                showNotYetMessage();
                return;
            }
            if(todayIndex===-2){
                document.getElementById('dayInfo').style.display='none';
                showWeekOverMessage();
                return;
            }

            const day=days[todayIndex];

            if(gameState.collected.includes(todayIndex)){
                showAlreadyCompleted(todayIndex);
            }else{
                startChallenge(todayIndex);
            }
        }

        init();
    </script>
</body>
</html>
