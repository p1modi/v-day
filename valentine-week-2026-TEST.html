<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Valentine's Week 2026 üíú [TEST MODE]</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

        body{
            font-family:'Georgia',serif;
            background:linear-gradient(135deg,#f5f1e8 0%,#e8dfd0 100%);
            min-height:100vh;
            display:flex;
            flex-direction:column;
            align-items:center;
            padding:20px;
            padding-top:50px;
            padding-bottom:60px;
            overflow-y:auto;
            -webkit-overflow-scrolling:touch;
        }

        .test-banner{
            position:fixed; top:0; left:0; right:0;
            background:#ff6b6b; color:#fff;
            text-align:center;
            padding:8px;
            font-size:.9rem;
            font-weight:bold;
            z-index:2000;
        }

        .container{ max-width:500px; width:100%; text-align:center; position:relative; z-index:10; margin-top:10px; }

        h1{
            color:#6b4c8a;
            font-size:2rem;
            margin-bottom:10px;
            text-shadow:2px 2px 4px rgba(0,0,0,0.1);
        }

        .date-display{ color:#8b7aa8; font-size:1.2rem; margin-bottom:30px; font-style:italic; }

        .day-selector{
            background:rgba(255,255,255,.8);
            border-radius:15px;
            padding:20px;
            margin-bottom:20px;
            box-shadow:0 5px 15px rgba(107,76,138,.2);
        }
        .day-selector h3{ color:#6b4c8a; margin-bottom:15px; font-size:1.1rem; }
        .day-buttons{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }

        .day-button{
            background:#6b4c8a; color:#fff;
            border:none;
            padding:12px;
            border-radius:10px;
            font-size:.9rem;
            cursor:pointer;
            transition:all .3s;
            font-family:'Georgia',serif;
        }
        .day-button:active{ transform:scale(.95); }
        .day-button.collected{ background:#d4c5b9; color:#6b4c8a; }

        .game-area{
            background:rgba(255,255,255,.6);
            border-radius:20px;
            padding:40px 20px;
            min-height:350px;
            position:relative;
            overflow:hidden;
            box-shadow:0 10px 30px rgba(107,76,138,.2);
            backdrop-filter:blur(10px);
        }

        .instruction{
            color:#6b4c8a;
            font-size:1.1rem;
            margin-bottom:20px;
            line-height:1.6;
            padding:0 10px;
        }

        .sprite{
            position:absolute;
            font-size:4rem;
            cursor:pointer;
            user-select:none;
            transition:transform .2s;
            filter:drop-shadow(0 4px 8px rgba(0,0,0,.2));
        }
        .sprite:active{ transform:scale(.9); }

        .message{
            color:#8b7aa8;
            font-size:1rem;
            margin-top:20px;
            min-height:30px;
            font-style:italic;
        }

        .success-message{
            color:#6b4c8a;
            font-size:1.3rem;
            font-weight:bold;
            animation:fadeInScale .5s ease;
        }
        @keyframes fadeInScale{ from{opacity:0; transform:scale(.8);} to{opacity:1; transform:scale(1);} }

        .particle{ position:absolute; pointer-events:none; font-size:1.5rem; }
        .confetti{ position:absolute; width:10px; height:10px; pointer-events:none; }

        .reset-button{
            position:fixed;
            bottom:10px;
            right:10px;
            background:rgba(139,122,168,.3);
            color:#6b4c8a;
            border:1px solid #8b7aa8;
            padding:8px 12px;
            border-radius:15px;
            font-size:.7rem;
            z-index:1000;
        }

        /* Chocolate scratch */
        .chocolate-stage{
            position:absolute;
            inset:0;
            border-radius:20px;
            overflow:hidden;
            touch-action:none;
        }
        .chocolate-layer{
            position:absolute;
            inset:0;
            width:100%;
            height:100%;
            display:block;
        }
        .choco-center{
            position:absolute;
            left:50%;
            top:50%;
            transform:translate(-50%,-50%);
            z-index:5;
            pointer-events:none;
        }
        .choco-float{
            font-size:5rem;
            filter:drop-shadow(0 8px 18px rgba(0,0,0,.3));
            animation:chocoFloat 2s ease-in-out infinite;
            pointer-events:auto;
            cursor:pointer;
            user-select:none;
        }
        @keyframes chocoFloat{
            0%,100%{ transform:translateY(0); }
            50%{ transform:translateY(-18px); }
        }

        @keyframes spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
        @keyframes heartbeat{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.2);} }
        @keyframes bounce{ 0%,100%{transform:translateY(0);} 50%{transform:translateY(-30px);} }
    </style>
</head>

<body>
    <div class="test-banner">üîß TEST MODE - All challenges available üîß</div>

    <div class="container">
        <h1>Valentine's Week 2026</h1>
        <div class="date-display" id="dateDisplay"></div>

        <div class="day-selector">
            <h3>Choose a challenge to test:</h3>
            <div class="day-buttons" id="dayButtons"></div>
        </div>

        <div class="game-area" id="gameArea">
            <div class="instruction">Select a day above to test its challenge!</div>
        </div>
    </div>

    <button class="reset-button" onclick="resetProgress()">Reset Progress</button>

    <script>
        /* =========================
           MODE + STORAGE
        ========================== */
        const TEST_MODE = true;
        const STORAGE_KEY = 'valentineCollectedTest';

        /* =========================
           DAYS (FIXED Chocolate object)
        ========================== */
        const days = [
            {
                date: new Date('2026-02-07'),
                name: "Rose Day",
                emoji: "üåπ",
                instruction: "Find the rose!",
                challenge: "colorChange",
                messages: { success: "Happy Rose Day babe! ‚ù§Ô∏è" }
            },
            {
                date: new Date('2026-02-08'),
                name: "Propose Day",
                emoji: "üíç",
                instruction: "",
                challenge: "runAway",
                messages: { success: "Together forever! üíç" }
            },
            {
                date: new Date('2026-02-09'),
                name: "Chocolate Day",
                emoji: "üç´",
                instruction: "",
                challenge: "chocolateSwipe",
                messages: {
                    melting: "",
                    secondLayer: "",
                    finalLayer: "",
                    tapChocolate: "",
                    success: "Happy Chocolate Day babe! ‚ù§Ô∏è"
                }
            },
            {
                date: new Date('2026-02-10'),
                name: "Teddy Day",
                emoji: "üß∏",
                instruction: "The teddy is shy! Catch it when it peeks out!",
                challenge: "peekaboo",
                messages: {
                    hiding: "Peek-a-boo!",
                    success: "You found me! Happy Teddy Day babe üíó üß∏"
                }
            },
            {
                date: new Date('2026-02-11'),
                name: "Promise Day",
                emoji: "ü§ù",
                instruction: "Tap the handshake 3 times to seal the promise!",
                challenge: "threeTaps",
                messages: {
                    first: "",
                    second: "",
                    third: "",
                    success: ""
                }
            },
            {
                date: new Date('2026-02-12'),
                name: "Hug Day",
                emoji: "ü§ó",
                instruction: "Tap both hearts to bring them together!",
                challenge: "simultaneous",
                messages: {
                    waiting: "",
                    miss: "",
                    success: ""
                }
            },
            {
                date: new Date('2026-02-13'),
                name: "Kiss Day",
                emoji: "üíã",
                instruction: "Quick! Catch the fleeting kiss!",
                challenge: "fleeting",
                messages: {
                    miss: "*mwah* Missed!",
                    appearing: "Quick, while the moment lasts!",
                    success: "Caught that kiss! üíã"
                }
            },
            {
                date: new Date('2026-02-14'),
                name: "Valentine's Day",
                emoji: "‚ù§Ô∏è",
                instruction: "Collect all the love!",
                challenge: "finale",
                messages: {
                    collecting: "The whole week in one moment!",
                    success: "Love conquers all... challenges! ‚ù§Ô∏è"
                }
            }
        ];

        let gameState = {
            collected: JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'),
        };

        function saveProgress() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState.collected));
        }

        function showMessage(text) {
            const messageEl = document.getElementById('message');
            if (messageEl) {
                messageEl.textContent = text;
                messageEl.className = 'message';
            }
        }

        function showSuccessMessage(text) {
            const messageEl = document.getElementById('message');
            if (messageEl) {
                messageEl.textContent = text;
                messageEl.className = 'message success-message';
            }
        }

        function createParticles(x, y) {
            const gameArea = document.getElementById('gameArea');
            const colors = ['#6b4c8a', '#8b7aa8', '#d4c5b9', '#f5f1e8', '#ffd700'];

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'confetti';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                const angle = (Math.PI * 2 * i) / 30;
                const velocity = 50 + Math.random() * 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                gameArea.appendChild(particle);
                particle.animate([
                    { transform: 'translate(0,0) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) rotate(${Math.random()*720}deg)`, opacity: 0 }
                ], {
                    duration: 1000 + Math.random() * 500,
                    easing: 'cubic-bezier(0, .9, .57, 1)'
                }).onfinish = () => particle.remove();
            }
        }

        function createHearts(x, y) {
            const gameArea = document.getElementById('gameArea');
            const hearts = ['üíú', 'üíó', 'üíñ', '‚ú®', 'üåü'];

            for (let i = 0; i < 15; i++) {
                const heart = document.createElement('div');
                heart.className = 'particle';
                heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.left = x + 'px';
                heart.style.top = y + 'px';
                gameArea.appendChild(heart);
                const tx = (Math.random() - 0.5) * 200;
                const ty = -100 - Math.random() * 100;
                heart.animate([
                    { transform: 'translate(0,0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0.5)`, opacity: 0 }
                ], { duration: 1500, easing: 'ease-out' }).onfinish = () => heart.remove();
            }
        }

        function collectSprite(dayIndex, x = null, y = null) {
            if (!gameState.collected.includes(dayIndex)) {
                gameState.collected.push(dayIndex);
                saveProgress();
                updateDayButtons();
            }

            const day = days[dayIndex];
            showSuccessMessage(day.messages.success);

            setTimeout(function () {
                const gameArea = document.getElementById('gameArea');
                gameArea.innerHTML =
                    `<div class="instruction">Great job! üéâ</div>
                     <div class="message">${TEST_MODE ? 'Select another day to test more challenges!' : 'Come back tomorrow for the next challenge!'}</div>`;
            }, 2200);
        }

        function finalizeChallenge(dayIndex, html) {
            if (!gameState.collected.includes(dayIndex)) {
                gameState.collected.push(dayIndex);
                saveProgress();
                updateDayButtons();
            }
            document.getElementById('gameArea').innerHTML = html; // persist
        }

        /* =========================================================
           ROSE DAY ‚Äî (your rich swipe game, with your fixes)
        ========================================================= */
        function startColorChange(dayIndex) {
            const gameArea = document.getElementById('gameArea');

            // clean slate
            gameArea.replaceWith(gameArea.cloneNode(false));
            const freshArea = document.getElementById('gameArea');

            let introStage = 0;

            freshArea.innerHTML =
                '<div class="instruction" id="instruction" style="font-size:1.8rem;margin-top:100px;">Happy Rose Day! üåπ</div>' +
                '<div class="message" id="message"></div>';

            function handleIntroTap() {
                introStage++;
                if (introStage === 1) {
                    const inst = document.getElementById('instruction');
                    inst.textContent = "But where's your rose?";
                    inst.style.fontSize = '1.5rem';
                    inst.style.marginTop = '0';
                } else if (introStage === 2) {
                    freshArea.removeEventListener('click', handleIntroTap);
                    startEmojiGame();
                }
            }
            freshArea.addEventListener('click', handleIntroTap);

            function startEmojiGame() {
                const emojis = [
                    '‚òÄÔ∏è','üß∏','üêï','üåà','‚≠ê','üåª','üçÄ','üå∏','üê±','ü¶Å','üê∫','ü¶ä','üêª','üêº','üê®','üêØ',
                    'ü¶Ö','ü¶â','üê¢','üê¨','üêã','üåç','üó∫Ô∏è','‚õ∞Ô∏è','üåã','üèîÔ∏è','üå≤','üå≥','üå¥','üåµ','üçÅ','üçÇ',
                    'üåæ','üåø','‚òòÔ∏è','üíé','üî•','üíß','‚ùÑÔ∏è','‚ö°','üåô','‚òÅÔ∏è','üåä','üèµÔ∏è','üå∑','üåº','ü™ª','‚öì',
                    'üß≠','‚ô†Ô∏è','‚ô£Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','‚òØÔ∏è','‚≠ï','‚ú≥Ô∏è','‚ùáÔ∏è','üî∂','üî∑'
                ];

                const totalEmojis = 240;
                let timerStarted = false;
                let timeLeft = 30;
                let timerInterval = null;
                let emojiElements = [];
                let roseMessageShown = false;
                let removedCount = 0;

                freshArea.innerHTML = '';
                freshArea.style.position = 'relative';
                freshArea.style.overflow = 'hidden';
                freshArea.style.touchAction = 'none';

                const header = document.createElement('div');
                header.style.cssText = 'position:relative;z-index:1001;padding:10px;text-align:center;';
                header.innerHTML =
                    '<div class="instruction" id="instruction">But where\'s your rose?</div>' +
                    '<div class="message" id="message"></div>';
                freshArea.appendChild(header);

                const emojiContainer = document.createElement('div');
                emojiContainer.id = 'emojiContainer';
                emojiContainer.style.cssText = 'position:absolute;top:80px;left:0;right:0;bottom:0;overflow:hidden;';
                freshArea.appendChild(emojiContainer);

                const containerHeight = freshArea.offsetHeight - 80;
                const containerWidth = freshArea.offsetWidth;

                const rose = document.createElement('div');
                rose.style.cssText =
                    'position:absolute;font-size:4rem;z-index:9999;cursor:pointer;' +
                    'transition:all 0.5s;pointer-events:auto;user-select:none;';
                rose.style.left = (20 + Math.random() * 50) + '%';
                rose.style.top = (20 + Math.random() * 50) + '%';
                rose.textContent = 'üåπ';
                emojiContainer.appendChild(rose);

                for (let i = 0; i < totalEmojis; i++) {
                    const emoji = document.createElement('div');
                    const size = 1.5 + Math.random() * 1.5;
                    emoji.style.cssText =
                        `position:absolute;font-size:${size}rem;pointer-events:none;transition:all 0.4s ease-out;user-select:none;`;
                    emoji.style.left = (Math.random() * 85) + '%';
                    emoji.style.top = (Math.random() * 85) + '%';
                    emoji.style.zIndex = 10 + Math.floor(i / 20);
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emojiContainer.appendChild(emoji);
                    emojiElements.push(emoji);
                }
                emojiElements.sort(() => Math.random() - 0.5);

                function getRemovalCount() {
                    const timeRatio = 1 - (timeLeft / 30);
                    if (timeRatio < 0.3) return 1;
                    if (timeRatio < 0.5) return Math.random() < 0.7 ? 1 : 2;
                    if (timeRatio < 0.65) return 2 + Math.floor(Math.random() * 2);
                    if (timeRatio < 0.8) return 5 + Math.floor(Math.random() * 3);
                    return 12 + Math.floor(Math.random() * 8);
                }

                function checkAllEmojisGone() {
                    for (let i = 0; i < emojiElements.length; i++) {
                        if (emojiElements[i].style.opacity !== '0') return false;
                    }
                    return true;
                }

                function removeEmojis(x, y) {
                    const count = getRemovalCount();
                    let removed = 0;

                    for (let i = 0; i < emojiElements.length && removed < count; i++) {
                        const emoji = emojiElements[i];
                        if (emoji.style.opacity !== '0') {
                            const rect = emoji.getBoundingClientRect();
                            const containerRect = emojiContainer.getBoundingClientRect();
                            const emojiX = rect.left - containerRect.left;
                            const emojiY = rect.top - containerRect.top;

                            const angle = Math.atan2(emojiY - y, emojiX - x);
                            const distance = 200 + Math.random() * 100;
                            const newX = Math.cos(angle) * distance;
                            const newY = Math.sin(angle) * distance;

                            emoji.style.transform =
                                `translate(${newX}px, ${newY}px) rotate(${Math.random() * 360}deg)`;
                            emoji.style.opacity = '0';
                            removed++;
                            removedCount++;
                        }
                    }

                    if (removedCount >= totalEmojis - 10) {
                        rose.style.transform = 'scale(1.3)';
                        rose.style.filter = 'drop-shadow(0 0 15px #ff69b4)';
                    }
                }

                let lastX = 0, lastY = 0;
                let isSwiping = false;

                function handleStart(e) {
                    if (e.target === rose) return;
                    e.preventDefault();
                    const point = e.touches ? e.touches[0] : e;
                    const containerRect = emojiContainer.getBoundingClientRect();
                    lastX = point.clientX - containerRect.left;
                    lastY = point.clientY - containerRect.top;
                    isSwiping = true;

                    if (!timerStarted) {
                        timerStarted = true;
                        timerInterval = setInterval(function () {
                            timeLeft--;

                            if (timeLeft <= 5 && removedCount < totalEmojis - 20) {
                                removeEmojis(containerWidth / 2, containerHeight / 2);
                            }

                            if (timeLeft <= 0) {
                                clearInterval(timerInterval);
                                emojiElements.forEach(el => el.style.opacity = '0');
                                rose.style.transform = 'scale(1.5)';
                                rose.style.filter = 'drop-shadow(0 0 20px #ff69b4)';
                            }
                        }, 1000);
                    }
                }

                function handleMove(e) {
                    if (!isSwiping) return;
                    e.preventDefault();
                    const point = e.touches ? e.touches[0] : e;
                    const containerRect = emojiContainer.getBoundingClientRect();
                    const x = point.clientX - containerRect.left;
                    const y = point.clientY - containerRect.top;

                    const dist = Math.sqrt((x - lastX) ** 2 + (y - lastY) ** 2);
                    if (dist > 15) {
                        removeEmojis(x, y);
                        lastX = x; lastY = y;
                    }
                }

                function handleEnd() { isSwiping = false; }

                emojiContainer.addEventListener('mousedown', handleStart);
                emojiContainer.addEventListener('mousemove', handleMove);
                emojiContainer.addEventListener('mouseup', handleEnd);
                emojiContainer.addEventListener('mouseleave', handleEnd);
                emojiContainer.addEventListener('touchstart', handleStart, { passive: false });
                emojiContainer.addEventListener('touchmove', handleMove, { passive: false });
                emojiContainer.addEventListener('touchend', handleEnd);

                function endRoseDay(x, y) {
                    if (timerInterval) clearInterval(timerInterval);

                    // remove layer before final UI to prevent overlap
                    emojiContainer.remove();

                    createHearts(x, y);
                    createParticles(x, y);

                    const inst = document.getElementById('instruction');
                    inst.textContent = 'Happy Rose Day babe! ‚ù§Ô∏è';
                    inst.style.fontSize = '1.6rem';

                    const msg = document.getElementById('message');
                    if (msg) msg.textContent = '';

                    setTimeout(function () {
                        finalizeChallenge(dayIndex,
                            '<div class="instruction" style="font-size:1.6rem;">Happy Rose Day babe! ‚ù§Ô∏è</div>' +
                            '<div class="message">Challenge cleared üåπ</div>'
                        );
                    }, 1200);
                }

                function tryCollectRose(ev) {
                    ev.preventDefault?.();
                    ev.stopPropagation();

                    if (roseMessageShown) return;
                    if (!checkAllEmojisGone()) return;

                    roseMessageShown = true;
                    const pt = ev.touches ? ev.touches[0] : (ev.changedTouches ? ev.changedTouches[0] : ev);
                    endRoseDay(pt.clientX, pt.clientY);
                }

                rose.addEventListener('pointerup', tryCollectRose, { passive: false });
                rose.addEventListener('touchend', tryCollectRose, { passive: false });
            }
        }

        /* =========================================================
           PROPOSE DAY ‚Äî (your rich shy guy game with bubble positioning + single final message)
        ========================================================= */
        function startRunAway(dayIndex) {
            const gameArea = document.getElementById('gameArea');

            gameArea.replaceWith(gameArea.cloneNode(false));
            const freshArea = document.getElementById('gameArea');

            freshArea.innerHTML = '<div class="instruction" id="instruction"></div><div class="message" id="message"></div>';

            let stage = 0;

            const guy = document.createElement('div');
            guy.className = 'sprite';
            guy.textContent = 'üôáüèΩ‚Äç‚ôÇÔ∏è';
            guy.style.left = '50%';
            guy.style.top = '50%';
            guy.style.transform = 'translate(-50%, -50%)';
            freshArea.appendChild(guy);

            const bubble = document.createElement('div');
            bubble.style.cssText =
                'position:absolute;background:white;padding:10px 15px;border-radius:15px;' +
                'box-shadow:0 2px 10px rgba(0,0,0,0.2);font-size:1.05rem;color:#6b4c8a;' +
                'opacity:0;transition:opacity 0.15s;z-index:100;max-width:70%;text-align:center;' +
                'pointer-events:none;';
            freshArea.appendChild(bubble);

            function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

            function showBubble(text, targetEl) {
                bubble.innerHTML = text;
                bubble.style.opacity = '1';

                const guyRect = targetEl.getBoundingClientRect();
                const areaRect = freshArea.getBoundingClientRect();

                bubble.style.left = '0px';
                bubble.style.top = '0px';
                bubble.style.transform = 'translateX(-50%)';

                const bubbleRect = bubble.getBoundingClientRect();

                let centerX = (guyRect.left - areaRect.left) + (guyRect.width / 2);
                let topY = (guyRect.top - areaRect.top) - bubbleRect.height - 10;

                if (topY < 10) topY = (guyRect.bottom - areaRect.top) + 10;

                centerX = clamp(centerX, bubbleRect.width / 2 + 10, areaRect.width - bubbleRect.width / 2 - 10);

                bubble.style.left = centerX + 'px';
                bubble.style.top = topY + 'px';
            }
            function hideBubble() { bubble.style.opacity = '0'; }

            function moveGuyRandom() {
                const areaRect = freshArea.getBoundingClientRect();
                const newX = 50 + Math.random() * (areaRect.width - 150);
                const newY = 90 + Math.random() * (areaRect.height - 210);
                guy.style.left = newX + 'px';
                guy.style.top = newY + 'px';
                guy.style.transform = 'translate(0,0)';
                if (bubble.style.opacity === '1') showBubble(bubble.innerHTML, guy);
            }

            let chaseCount = 0;
            let tapCount = 0;

            // stage 2: tap empty area 3x to bring him back
            freshArea.addEventListener('click', function (e) {
                if (e.target === freshArea && stage === 2) {
                    tapCount++;
                    if (tapCount >= 3) {
                        stage = 3;
                        tapCount = 0;
                        guy.style.opacity = '1';
                        moveGuyRandom();
                    }
                }
            });

            function endProposeDay(x, y) {
                createHearts(x, y);
                createParticles(x, y);

                const inst = document.getElementById('instruction');
                inst.innerHTML =
                    '<div style="text-align:center; line-height:1.25;">' +
                        '<div style="font-size:1.6rem; font-weight:bold;">Together forever! üíç</div>' +
                        '<div style="font-size:1.25rem; margin-top:6px;">Happy Propose Day babe! ‚ù§Ô∏è</div>' +
                        '<div style="font-size:1.25rem; margin-top:6px;">‚òÄÔ∏è‚òÄÔ∏èüåªüåª</div>' +
                    '</div>';

                const msg = document.getElementById('message');
                if (msg) msg.textContent = '';

                setTimeout(function () {
                    finalizeChallenge(dayIndex,
                        '<div class="instruction" style="font-size:1.5rem; line-height:1.3;">' +
                            '<div style="font-weight:bold;">Together forever! üíç</div>' +
                            '<div style="margin-top:6px;">Happy Propose Day babe! ‚ù§Ô∏è</div>' +
                            '<div style="margin-top:6px;">‚òÄÔ∏è‚òÄÔ∏èüåªüåª</div>' +
                        '</div>' +
                        '<div class="message">Challenge cleared üíú</div>'
                    );
                }, 1400);
            }

            guy.addEventListener('click', function (e) {
                e.stopPropagation();

                if (stage === 0) {
                    showBubble('Hi', guy);
                    stage = 1;
                    setTimeout(function () {
                        hideBubble();
                        setTimeout(function () {
                            guy.style.opacity = '0';
                            stage = 2;
                        }, 500);
                    }, 1200);

                } else if (stage === 3) {
                    showBubble('I was thinking....', guy);
                    stage = 4;
                    setTimeout(function () {
                        hideBubble();
                        setTimeout(function () {
                            guy.style.opacity = '0';
                            setTimeout(function () {
                                guy.style.opacity = '1';
                                moveGuyRandom();
                                stage = 5;
                            }, 700);
                        }, 400);
                    }, 1600);

                } else if (stage === 5) {
                    chaseCount++;
                    if (chaseCount < 5) {
                        moveGuyRandom();
                        guy.style.transition = 'all 0.25s ease';
                    } else {
                        stage = 6;
                        guy.style.left = '50%';
                        guy.style.top = '40%';
                        guy.style.transform = 'translate(-50%, -50%)';
                    }

                } else if (stage === 6) {
                    showBubble('Be mine? üíï', guy);
                    stage = 7;

                    setTimeout(function () {
                        const ring = document.createElement('div');
                        ring.className = 'sprite';
                        ring.textContent = 'üíç';
                        ring.style.left = '70%';
                        ring.style.top = '50%';
                        ring.style.fontSize = '3rem';
                        ring.style.animation = 'heartbeat 1s ease infinite';
                        freshArea.appendChild(ring);

                        ring.addEventListener('click', function (ev) {
                            ev.stopPropagation();
                            hideBubble();
                            guy.remove();
                            ring.remove();

                            const couple = document.createElement('div');
                            couple.className = 'sprite';
                            couple.textContent = 'üë´';
                            couple.style.left = '50%';
                            couple.style.top = '45%';
                            couple.style.transform = 'translate(-50%, -50%)';
                            couple.style.fontSize = '5rem';
                            freshArea.appendChild(couple);

                            endProposeDay(ev.clientX, ev.clientY);
                        });
                    }, 900);
                }
            });
        }

        /* =========================================================
           CHOCOLATE DAY ‚Äî clean working 3-layer scratch (rich game, stable)
        ========================================================= */
        function startChocolateSwipe(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];

            gameArea.innerHTML = '<div class="instruction" id="instruction"></div><div class="message" id="message"></div>';

            const stage = document.createElement('div');
            stage.className = 'chocolate-stage';
            gameArea.appendChild(stage);

            const center = document.createElement('div');
            center.className = 'choco-center';
            stage.appendChild(center);

            const choc = document.createElement('div');
            choc.className = 'choco-float';
            choc.textContent = 'üç´';
            choc.style.display = 'none';
            center.appendChild(choc);

            const prompts = [day.messages.melting, day.messages.secondLayer, day.messages.finalLayer];
            let layerIndex = 0;

            function setPrompt(t) { showMessage(t); }

            const layerStyles = [
                { base:'#6a1b9a', type:'glaze' },
                { base:'#f9f9f6', type:'paper' },
                { base:'#c9a53a', type:'foil' }
            ];

            function drawTexture(ctx, w, h, style) {
                ctx.fillStyle = style.base;
                ctx.fillRect(0, 0, w, h);

                if (style.type === 'glaze') {
                    const g = ctx.createLinearGradient(0, 0, w, h);
                    g.addColorStop(0, 'rgba(255,255,255,0.34)');
                    g.addColorStop(0.35, 'rgba(255,255,255,0.06)');
                    g.addColorStop(0.62, 'rgba(255,255,255,0.28)');
                    g.addColorStop(1, 'rgba(255,255,255,0.08)');
                    ctx.fillStyle = g;
                    ctx.fillRect(0, 0, w, h);
                } else if (style.type === 'paper') {
                    ctx.strokeStyle = 'rgba(80,80,80,0.12)';
                    ctx.lineWidth = 1;
                    for (let x = -h; x < w + h; x += 18) {
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x + h, h);
                        ctx.stroke();
                    }
                } else if (style.type === 'foil') {
                    const g = ctx.createLinearGradient(0, 0, w, 0);
                    g.addColorStop(0, 'rgba(255,255,255,0.16)');
                    g.addColorStop(0.2, 'rgba(255,255,255,0.38)');
                    g.addColorStop(0.5, 'rgba(120,84,14,0.22)');
                    g.addColorStop(0.8, 'rgba(255,255,255,0.28)');
                    g.addColorStop(1, 'rgba(98,68,12,0.2)');
                    ctx.fillStyle = g;
                    ctx.fillRect(0, 0, w, h);

                    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
                    for (let y = 0; y < h; y += 20) {
                        ctx.beginPath();
                        ctx.moveTo(0, y + Math.random() * 6);
                        ctx.lineTo(w, y + Math.random() * 6);
                        ctx.stroke();
                    }
                }
            }

            function createLayer(style) {
                const rect = stage.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;

                const canvas = document.createElement('canvas');
                canvas.className = 'chocolate-layer';
                canvas.width = Math.floor(rect.width * dpr);
                canvas.height = Math.floor(rect.height * dpr);
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';

                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

                drawTexture(ctx, rect.width, rect.height, style);

                stage.appendChild(canvas);

                // downsampled ratio check (fast)
                const sample = document.createElement('canvas');
                sample.width = 80; sample.height = 80;
                const sctx = sample.getContext('2d', { willReadFrequently: true });

                const state = {
                    canvas, ctx,
                    rectW: rect.width,
                    rectH: rect.height,
                    drawing: false,
                    last: null,
                    getClearedRatio: function() {
                        sctx.clearRect(0,0,sample.width,sample.height);
                        sctx.drawImage(canvas, 0, 0, sample.width, sample.height);
                        const data = sctx.getImageData(0,0,sample.width,sample.height).data;
                        let transparent = 0;
                        for (let i = 3; i < data.length; i += 4) {
                            if (data[i] < 18) transparent++;
                        }
                        return transparent / (sample.width * sample.height);
                    }
                };

                bindScratch(state);
                return state;
            }

            function bindScratch(layer) {
                const brushSize = Math.max(60, Math.floor(layer.rectW * 0.12));

                function toLocal(clientX, clientY) {
                    const r = layer.canvas.getBoundingClientRect();
                    const x = clientX - r.left;
                    const y = clientY - r.top;
                    return { x, y };
                }

                function eraseLine(from, to) {
                    layer.ctx.globalCompositeOperation = 'destination-out';
                    layer.ctx.lineCap = 'round';
                    layer.ctx.lineJoin = 'round';
                    layer.ctx.strokeStyle = 'rgba(0,0,0,1)';
                    layer.ctx.lineWidth = brushSize;

                    layer.ctx.beginPath();
                    layer.ctx.moveTo(from.x, from.y);
                    layer.ctx.lineTo(to.x, to.y);
                    layer.ctx.stroke();
                }

                function erasePoint(p) {
                    layer.ctx.globalCompositeOperation = 'destination-out';
                    layer.ctx.beginPath();
                    layer.ctx.arc(p.x, p.y, brushSize * 0.55, 0, Math.PI * 2);
                    layer.ctx.fill();
                }

                function onDown(e) {
                    layer.drawing = true;
                    layer.last = null;
                    layer.canvas.setPointerCapture(e.pointerId);
                    const p = toLocal(e.clientX, e.clientY);
                    erasePoint(p);
                    layer.last = p;
                }

                function onMove(e) {
                    if (!layer.drawing) return;
                    const p = toLocal(e.clientX, e.clientY);
                    if (layer.last) eraseLine(layer.last, p);
                    erasePoint(p);
                    layer.last = p;

                    // advance when enough scratched
                    if (layer.getClearedRatio() > 0.92) {
                        layer.drawing = false;
                        layer.canvas.remove();
                        layerIndex++;
                        if (layerIndex < 3) {
                            setPrompt(prompts[layerIndex]);
                            activeLayer = createLayer(layerStyles[layerIndex]);
                        } else {
                            setPrompt(day.messages.tapChocolate);
                            choc.style.display = 'block';
                            choc.onclick = function(ev) {
                                createParticles(ev.clientX, ev.clientY);
                                collectSprite(dayIndex, ev.clientX, ev.clientY);
                            };
                        }
                    }
                }

                function onUp(e) {
                    layer.drawing = false;
                    layer.last = null;
                    try { layer.canvas.releasePointerCapture(e.pointerId); } catch {}
                }

                layer.canvas.addEventListener('pointerdown', onDown);
                layer.canvas.addEventListener('pointermove', onMove);
                layer.canvas.addEventListener('pointerup', onUp);
                layer.canvas.addEventListener('pointercancel', onUp);
            }

            setPrompt(day.messages.melting);
            let activeLayer = createLayer(layerStyles[layerIndex]);
        }

        /* =========================================================
           TEDDY 
        ========================================================= */

function startPeekaboo(dayIndex) {
    const gameArea = document.getElementById('gameArea');

    // Clean slate (no intro text)
    gameArea.innerHTML = '<div class="instruction" id="instruction"></div><div class="message" id="message"></div>';

    // Internal state
    let foundCount = 0;
    let currentSpot = null;
    let lastPeekTime = 0;
    let peekTimer = null;
    let peekEl = null;
    let pulseTimer = null;

    // Furniture setup (larger)
    const furnitureConfig = [
        { key: 'couch',  emoji: 'üõãÔ∏è', left: '10%', top: '65%' },
        { key: 'bed',    emoji: 'üõèÔ∏è', left: '65%', top: '65%' },
        { key: 'door',   emoji: 'üö™', left: '10%', top: '10%' },
        { key: 'window', emoji: 'ü™ü', left: '65%', top: '10%' }
    ];

    const furnitureEls = {};

    furnitureConfig.forEach(cfg => {
        const el = document.createElement('div');
        el.className = 'sprite';
        el.textContent = cfg.emoji;
        el.style.left = cfg.left;
        el.style.top = cfg.top;
        el.style.fontSize = '5rem'; // much larger
        el.style.transition = 'transform 0.25s ease';
        gameArea.appendChild(el);
        furnitureEls[cfg.key] = el;

        el.addEventListener('click', function (e) {
            e.stopPropagation();
            const now = Date.now();
            const isCorrect = (cfg.key === currentSpot) && (now - lastPeekTime <= 750); // harder

            if (!isCorrect) {
                el.style.transform = 'scale(1.15) rotate(-4deg)';
                setTimeout(() => { el.style.transform = ''; }, 200);
                showMessage('Not here! üëÄ');
                return;
            }

            // Correct
            foundCount++;

            if (peekEl) {
                peekEl.remove();
                peekEl = null;
            }

            const teddy = document.createElement('div');
            teddy.className = 'sprite';
            teddy.textContent = 'üß∏';
            teddy.style.left = cfg.left;
            teddy.style.top = cfg.top;
            teddy.style.fontSize = '4.5rem';
            teddy.style.animation = 'bounce 0.5s ease';
            gameArea.appendChild(teddy);

            createHearts(e.clientX, e.clientY);

            setTimeout(() => teddy.remove(), 500);

            if (foundCount >= 3) {
                clearTimeout(peekTimer);
                clearInterval(pulseTimer);

                // remove all furniture
                Object.values(furnitureEls).forEach(el => el.remove());

                createParticles(e.clientX, e.clientY);
                showMessage('üíóüß∏');

                setTimeout(() => {
                    collectSprite(dayIndex);
                }, 700);
                return;
            }

            pickNewSpot();
        });
    });

    function pickNewSpot() {
        const keys = Object.keys(furnitureEls).filter(k => k !== currentSpot);
        currentSpot = keys[Math.floor(Math.random() * keys.length)];
        schedulePeek();
    }

    function schedulePeek() {
        clearTimeout(peekTimer);
        const delay = 2000 + Math.random() * 800;
        peekTimer = setTimeout(showPeek, delay);
    }

    function showPeek() {
        if (peekEl) {
            peekEl.remove();
            peekEl = null;
        }

        const spotEl = furnitureEls[currentSpot];
        const rect = spotEl.getBoundingClientRect();
        const areaRect = gameArea.getBoundingClientRect();

        peekEl = document.createElement('div');
        peekEl.textContent = 'üß∏';
        peekEl.style.position = 'absolute';
        peekEl.style.fontSize = '2.2rem';
        peekEl.style.left = (rect.left - areaRect.left + rect.width * 0.65) + 'px';
        peekEl.style.top = (rect.top - areaRect.top + rect.height * 0.25) + 'px';
        peekEl.style.opacity = '0';
        peekEl.style.transition = 'opacity 0.2s ease';
        gameArea.appendChild(peekEl);

        requestAnimationFrame(() => {
            peekEl.style.opacity = '1';
        });

        lastPeekTime = Date.now();

        // Hide faster
        setTimeout(() => {
            if (peekEl) {
                peekEl.style.opacity = '0';
                setTimeout(() => {
                    if (peekEl) {
                        peekEl.remove();
                        peekEl = null;
                    }
                }, 150);
            }
            schedulePeek();
        }, 500);
    }

    // Random single-furniture pulse (independent of teddy)
    pulseTimer = setInterval(() => {
        const keys = Object.keys(furnitureEls);
        if (!keys.length) return;
        const el = furnitureEls[keys[Math.floor(Math.random() * keys.length)]];
        el.style.transform = 'scale(1.15)';
        setTimeout(() => { el.style.transform = ''; }, 250);
    }, 1200 + Math.random() * 800);

    // Start
    pickNewSpot();
}
        

        /* =========================================================
           PROMISE 
        ========================================================= */
function startThreeTaps(dayIndex) {
    const gameArea = document.getElementById('gameArea');

    // Clean slate
    gameArea.innerHTML =
        '<div class="instruction" id="instruction"></div>' +
        '<div class="message" id="message"></div>';

    // Disable text selection aggressively (iOS-safe)
    gameArea.style.userSelect = 'none';
    gameArea.style.webkitUserSelect = 'none';
    gameArea.style.webkitTouchCallout = 'none';

    // Hands
    const leftHand = document.createElement('div');
    leftHand.className = 'sprite';
    leftHand.textContent = 'ü´≥üèΩ';
    leftHand.style.left = '25%';
    leftHand.style.top = '40%';

    const rightHand = document.createElement('div');
    rightHand.className = 'sprite';
    rightHand.textContent = 'ü´¥üèΩ';
    rightHand.style.left = '65%';
    rightHand.style.top = '40%';
    rightHand.style.transform = 'scaleX(-1)';

    gameArea.appendChild(leftHand);
    gameArea.appendChild(rightHand);

    // Hold control (circle, bottom-right)
    const holdPad = document.createElement('div');
    holdPad.style.cssText = `
        position:absolute;
        right:16px;
        bottom:16px;
        width:64px;
        height:64px;
        border-radius:50%;
        background:rgba(139,122,168,0.35);
        touch-action:none;
        user-select:none;
        -webkit-user-select:none;
        -webkit-touch-callout:none;
    `;
    gameArea.appendChild(holdPad);

    let moving = false;
    let vx1 = 0, vy1 = 0, vx2 = 0, vy2 = 0;
    let rafId = null;

    function randomVelocity() {
        const speed = 2 + Math.random() * 5; // slow ‚Üí fast randomness
        const angle = Math.random() * Math.PI * 2;
        return { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed };
    }

    function startMoving(e) {
        e.preventDefault();
        if (moving) return;
        moving = true;

        ({ x: vx1, y: vy1 } = randomVelocity());
        ({ x: vx2, y: vy2 } = randomVelocity());

        animate();
    }

    function stopMoving(e) {
        e.preventDefault();
        if (!moving) return;
        moving = false;
        cancelAnimationFrame(rafId);

        if (areStronglyOverlapping()) {
            completePromise(e.clientX, e.clientY);
        }
    }

    function animate() {
        if (!moving) return;

        moveSprite(leftHand, v => { vx1 = v.x; vy1 = v.y; }, vx1, vy1);
        moveSprite(rightHand, v => { vx2 = v.x; vy2 = v.y; }, vx2, vy2);

        // Random speed + direction changes
        if (Math.random() < 0.03) ({ x: vx1, y: vy1 } = randomVelocity());
        if (Math.random() < 0.03) ({ x: vx2, y: vy2 } = randomVelocity());

        rafId = requestAnimationFrame(animate);
    }

    function moveSprite(el, setV, vx, vy) {
        const area = gameArea.getBoundingClientRect();
        const r = el.getBoundingClientRect();

        let x = r.left - area.left + vx;
        let y = r.top - area.top + vy;

        if (x < 0 || x > area.width - r.width) vx *= -1;
        if (y < 0 || y > area.height - r.height) vy *= -1;

        setV({ x: vx, y: vy });

        el.style.left = (r.left - area.left + vx) + 'px';
        el.style.top = (r.top - area.top + vy) + 'px';
    }

    // Require strong overlap (‚âà60% area intersection)
    function areStronglyOverlapping() {
        const r1 = leftHand.getBoundingClientRect();
        const r2 = rightHand.getBoundingClientRect();

        const xOverlap = Math.max(0, Math.min(r1.right, r2.right) - Math.max(r1.left, r2.left));
        const yOverlap = Math.max(0, Math.min(r1.bottom, r2.bottom) - Math.max(r1.top, r2.top));
        const overlapArea = xOverlap * yOverlap;

        const minArea = Math.min(r1.width * r1.height, r2.width * r2.height);
        return overlapArea > minArea * 0.6;
    }

    function completePromise(x, y) {
        leftHand.remove();
        rightHand.remove();
        holdPad.remove();

        const handshake = document.createElement('div');
        handshake.className = 'sprite';
        handshake.textContent = 'ü§ùüèΩ';
        handshake.style.left = '50%';
        handshake.style.top = '45%';
        handshake.style.transform = 'translate(-50%, -50%)';
        handshake.style.fontSize = '4.5rem';
        handshake.style.animation = 'heartbeat 0.8s ease-in-out infinite';
        gameArea.appendChild(handshake);

        createHearts(x, y);
        createParticles(x, y);

        // Glow + pulse for 3s
        setTimeout(() => {
            handshake.remove();
            showMessage('Promise made! I got your back and you got mine. Happy Promise Day babe! üíó');

            setTimeout(() => {
                collectSprite(dayIndex, x, y);
            }, 5000);
        }, 3000);
    }

    // Pointer-safe handlers
    holdPad.addEventListener('pointerdown', startMoving);
    holdPad.addEventListener('pointerup', stopMoving);
    holdPad.addEventListener('pointerleave', stopMoving);
    holdPad.addEventListener('pointercancel', stopMoving);
}

    
        /* =========================================================
          HUG 
        ========================================================= */


        function startSimultaneous(dayIndex) {
    const gameArea = document.getElementById('gameArea');

    gameArea.innerHTML =
        '<div class="instruction" id="instruction"></div>' +
        '<div class="message" id="message"></div>';

    gameArea.style.userSelect = 'none';
    gameArea.style.webkitUserSelect = 'none';
    gameArea.style.webkitTouchCallout = 'none';

    const TAP_TARGET = 35; // preset continuous taps required
    let tapCount = 0;
    let warmth = 0;
    let lastTapTime = Date.now();
    let completed = false;

    // Container for centered alignment
    const centerWrap = document.createElement('div');
    centerWrap.style.cssText = `
        position:absolute;
        left:50%;
        top:45%;
        transform:translate(-50%, -50%);
        width:120px;
        height:120px;
        display:flex;
        align-items:center;
        justify-content:center;
        pointer-events:none;
    `;
    gameArea.appendChild(centerWrap);

    // Glow (behind emoji)
    const glow = document.createElement('div');
    glow.style.cssText = `
        position:absolute;
        width:120px;
        height:120px;
        border-radius:50%;
        background:radial-gradient(circle, rgba(255,120,120,0.55) 0%, rgba(255,120,120,0.25) 40%, transparent 70%);
        transform:scale(0.5);
        opacity:0.4;
    `;
    centerWrap.appendChild(glow);

    // Cold face
    const face = document.createElement('div');
    face.className = 'sprite';
    face.textContent = 'ü•∂';
    face.style.position = 'relative';
    face.style.fontSize = '4.5rem';
    centerWrap.appendChild(face);

    function updateVisuals() {
        warmth = tapCount / TAP_TARGET;

        // Glow grows
        const scale = 0.5 + warmth * 1.4;
        glow.style.transform = `scale(${scale})`;
        glow.style.opacity = 0.4 + warmth * 0.6;

        // Shiver intensity reduces
        const jitter = (1 - warmth) * 6;
        face.style.transform =
            `translate(${(Math.random() - 0.5) * jitter}px, ${(Math.random() - 0.5) * jitter}px)`;

        // Pulse speed increases slightly
        const pulseSpeed = 1.2 - warmth * 0.7;
        glow.style.animation = `heartbeat ${pulseSpeed}s ease-in-out infinite`;
    }

    function drainCheck() {
        if (completed) return;

        const now = Date.now();

        // If tapping stops for too long, reduce tap streak slightly
        if (now - lastTapTime > 600 && tapCount > 0) {
            tapCount -= 1;
            if (tapCount < 0) tapCount = 0;
        }

        updateVisuals();
        requestAnimationFrame(drainCheck);
    }

    function tapHandler(e) {
        if (completed) return;

        lastTapTime = Date.now();
        tapCount++;

        // Hearts + fire burst
        const effects = ['üíó','üíú','üî•','‚ù§Ô∏è','üî•'];
        for (let i = 0; i < 8; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.textContent = effects[Math.floor(Math.random() * effects.length)];
            p.style.left = e.clientX + 'px';
            p.style.top = e.clientY + 'px';
            gameArea.appendChild(p);

            const tx = (Math.random() - 0.5) * 180;
            const ty = -80 - Math.random() * 120;

            p.animate([
                { transform: 'translate(0,0) scale(1)', opacity: 1 },
                { transform: `translate(${tx}px, ${ty}px) scale(0.5)`, opacity: 0 }
            ], { duration: 900, easing: 'ease-out' }).onfinish = () => p.remove();
        }

        updateVisuals();

        if (tapCount >= TAP_TARGET) {
            completeWarmup(e.clientX, e.clientY);
        }
    }

    function completeWarmup(x, y) {
        completed = true;

        // Fade cold face
        face.style.transition = 'opacity 0.6s ease';
        face.style.opacity = '0';

        setTimeout(() => {
            face.textContent = 'üòä';
            face.style.opacity = '1';
            face.style.transform = 'translate(0,0)';
            face.style.animation = 'heartbeat 0.8s ease-in-out infinite';

            createParticles(x, y);

            // After 3s ‚Üí replace with hug emoji
            setTimeout(() => {
                face.textContent = 'ü´Ç';
                face.style.animation = 'heartbeat 0.9s ease-in-out infinite';

                showMessage("All warm now. Happy Hug Day babe ü§óüíú");

                setTimeout(() => {
                    collectSprite(dayIndex, x, y);
                }, 5000);

            }, 3000);

        }, 700);
    }

    gameArea.addEventListener('pointerdown', tapHandler);

    drainCheck();
}


        
        /* =========================================================
            KISS / FINALE (kept as your rich versions)
        ========================================================= */


        
        function startFleeting(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];

            gameArea.innerHTML = '<div class="instruction" id="instruction">' + day.instruction + '</div><div class="message" id="message"></div>';

            function spawnKiss() {
                const rect = gameArea.getBoundingClientRect();
                const sprite = document.createElement('div');
                sprite.className = 'sprite';
                sprite.textContent = day.emoji;
                sprite.style.left = (Math.random() * (rect.width - 80)) + 'px';
                sprite.style.top = (Math.random() * (rect.height - 80)) + 'px';
                sprite.style.opacity = '0';
                gameArea.appendChild(sprite);

                setTimeout(function () {
                    sprite.style.opacity = '1';
                    sprite.style.transition = 'opacity 0.3s';
                }, 100);

                showMessage(day.messages.appearing);

                const disappear = setTimeout(function () {
                    sprite.style.opacity = '0';
                    setTimeout(function () {
                        sprite.remove();
                        showMessage(day.messages.miss);
                        setTimeout(spawnKiss, 800);
                    }, 300);
                }, 1500);

                sprite.addEventListener('click', function (e) {
                    clearTimeout(disappear);
                    createParticles(e.clientX, e.clientY);
                    sprite.style.animation = 'spin 0.5s ease';
                    setTimeout(function () {
                        sprite.remove();
                        collectSprite(dayIndex, e.clientX, e.clientY);
                    }, 500);
                });
            }

            spawnKiss();
        }

        function startFinale(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];

            gameArea.innerHTML = '<div class="instruction" id="instruction">' + day.instruction + '</div><div class="message" id="message"></div>';
            showMessage(day.messages.collecting);

            const allEmojis = days.map(d => d.emoji);
            let collectedCount = 0;

            allEmojis.forEach(function (emoji, index) {
                setTimeout(function () {
                    const sprite = document.createElement('div');
                    sprite.className = 'sprite';
                    sprite.textContent = emoji;
                    const angle = (Math.PI * 2 * index) / allEmojis.length;
                    sprite.style.left = (50 + Math.cos(angle) * 30) + '%';
                    sprite.style.top = (50 + Math.sin(angle) * 30) + '%';
                    sprite.style.animation = 'chocoFloat 2s ease-in-out infinite';
                    sprite.style.animationDelay = (index * 0.1) + 's';
                    gameArea.appendChild(sprite);

                    sprite.addEventListener('click', function (e) {
                        collectedCount++;
                        createParticles(e.clientX, e.clientY);
                        sprite.remove();
                        if (collectedCount === allEmojis.length) {
                            setTimeout(function () { collectSprite(dayIndex, e.clientX, e.clientY); }, 500);
                        }
                    });
                }, index * 200);
            });
        }

        function startChallenge(dayIndex) {
            const day = days[dayIndex];
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = '<div class="instruction" id="instruction">' + (day.instruction || '') + '</div><div class="message" id="message"></div>';

            switch (day.challenge) {
                case 'colorChange': startColorChange(dayIndex); break;
                case 'runAway': startRunAway(dayIndex); break;
                case 'chocolateSwipe': startChocolateSwipe(dayIndex); break;
                case 'peekaboo': startPeekaboo(dayIndex); break;
                case 'threeTaps': startThreeTaps(dayIndex); break;
                case 'simultaneous': startSimultaneous(dayIndex); break;
                case 'fleeting': startFleeting(dayIndex); break;
                case 'finale': startFinale(dayIndex); break;
            }
        }

        function updateDayButtons() {
            const container = document.getElementById('dayButtons');
            container.innerHTML = '';
            days.forEach(function (day, index) {
                const button = document.createElement('button');
                button.className = 'day-button';
                if (gameState.collected.includes(index)) button.classList.add('collected');
                button.textContent = day.emoji + ' ' + day.name;
                button.onclick = function () { startChallenge(index); };
                container.appendChild(button);
            });
        }

        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress?')) {
                gameState.collected = [];
                saveProgress();
                updateDayButtons();
                document.getElementById('gameArea').innerHTML =
                    '<div class="instruction">Progress reset! Select a day above to test.</div>';
            }
        }

        function init() {
            document.getElementById('dateDisplay').textContent =
                new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            updateDayButtons();
        }

        init();
    </script>
</body>
</html>
