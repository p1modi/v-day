<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Valentine's Week 2026 üíú [TEST MODE]</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #f5f1e8 0%, #e8dfd0 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-top: 50px;
            padding-bottom: 60px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .test-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff6b6b;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 2000;
        }

        .container {
            max-width: 500px;
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 10;
            margin-top: 10px;
        }

        h1 {
            color: #6b4c8a;
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .date-display {
            color: #8b7aa8;
            font-size: 1.2rem;
            margin-bottom: 30px;
            font-style: italic;
        }

        .day-selector {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(107, 76, 138, 0.2);
        }

        .day-selector h3 {
            color: #6b4c8a;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .day-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .day-button {
            background: #6b4c8a;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Georgia', serif;
        }

        .day-button:active {
            transform: scale(0.95);
        }

        .day-button.collected {
            background: #d4c5b9;
            color: #6b4c8a;
        }

        .game-area {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 40px 20px;
            min-height: 350px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(107, 76, 138, 0.2);
            backdrop-filter: blur(10px);
        }

        .instruction {
            color: #6b4c8a;
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.6;
            padding: 0 10px;
        }

        .sprite {
            position: absolute;
            font-size: 4rem;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .sprite:active {
            transform: scale(0.9);
        }

        .message {
            color: #8b7aa8;
            font-size: 1rem;
            margin-top: 20px;
            min-height: 30px;
            font-style: italic;
        }

        .success-message {
            color: #6b4c8a;
            font-size: 1.3rem;
            font-weight: bold;
            animation: fadeInScale 0.5s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            font-size: 1.5rem;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            pointer-events: none;
        }

        .reset-button {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(139, 122, 168, 0.3);
            color: #6b4c8a;
            border: 1px solid #8b7aa8;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            z-index: 1000;
        }

        .chocolate-stage {
            position: absolute;
            inset: 0;
            border-radius: 20px;
            overflow: hidden;
            touch-action: none;
        }

        .chocolate-layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        .chocolate-target {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            cursor: pointer;
            user-select: none;
            filter: drop-shadow(0 8px 18px rgba(0, 0, 0, 0.3));
            animation: float 2s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }
    </style>
</head>
<body>
    <div class="test-banner">üîß TEST MODE - All challenges available üîß</div>
    
    <div class="container">
        <h1>Valentine's Week 2026</h1>
        <div class="date-display" id="dateDisplay"></div>
        
        <div class="day-selector">
            <h3>Choose a challenge to test:</h3>
            <div class="day-buttons" id="dayButtons"></div>
        </div>
        
        <div class="game-area" id="gameArea">
            <div class="instruction">Select a day above to test its challenge!</div>
        </div>
    </div>

    <button class="reset-button" onclick="resetProgress()">Reset Progress</button>

    <script>
        const days = [
            {
                date: new Date('2026-02-07'),
                name: "Rose Day",
                emoji: "üåπ",
                instruction: "Find the rose!",
                challenge: "colorChange",
                messages: {
                    wrong: "Keep looking!",
                    miss: "Where is it?",
                    success: "Happy Rose Day babe! ‚ù§Ô∏è"
                }
            },
            {
                date: new Date('2026-02-08'),
                name: "Propose Day",
                emoji: "üíç",
                instruction: "",
                challenge: "runAway",
                messages: {
                    miss: "Will you... wait, I'm nervous!",
                    running: "Getting cold feet here!",
                    success: "Together forever! üíç"
                }
            },
            {
                date: new Date('2026-02-09'),
                name: "Chocolate Day",
                emoji: "üç´",
                instruction: "Swipe away all 3 wrappers to reveal your chocolate!",
                challenge: "chocolateSwipe",
                messages: {
                    melting: "Scratch off the purple glaze first!",
                    secondLayer: "Yum! Now clear the white paper layer!",
                    finalLayer: "Almost there! Swipe away the gold foil!",
                    tapChocolate: "Tap the chocolate bar üç´",
                    success: "Happy Chocolate Day babe! ‚ù§Ô∏è"
                }
            },
            {
                date: new Date('2026-02-10'),
                name: "Teddy Day",
                emoji: "üß∏",
                instruction: "The teddy is shy! Catch it when it peeks out!",
                challenge: "peekaboo",
                messages: {
                    hiding: "Peek-a-boo!",
                    miss: "Too shy to come out fully!",
                    success: "You found me! So cozy now. üß∏"
                }
            },
            {
                date: new Date('2026-02-11'),
                name: "Promise Day",
                emoji: "ü§ù",
                instruction: "Tap the handshake 3 times to seal the promise!",
                challenge: "threeTaps",
                messages: {
                    first: "Can you commit?",
                    second: "Once more!",
                    third: "One last promise!",
                    success: "Sealed with three taps! ü§ù"
                }
            },
            {
                date: new Date('2026-02-12'),
                name: "Hug Day",
                emoji: "ü§ó",
                instruction: "Tap both hearts to bring them together!",
                challenge: "simultaneous",
                messages: {
                    waiting: "It takes two to hug!",
                    miss: "Bring us together!",
                    success: "Finally embraced! ü§ó"
                }
            },
            {
                date: new Date('2026-02-13'),
                name: "Kiss Day",
                emoji: "üíã",
                instruction: "Quick! Catch the fleeting kiss!",
                challenge: "fleeting",
                messages: {
                    miss: "*mwah* Missed!",
                    appearing: "Quick, while the moment lasts!",
                    success: "Caught that kiss! üíã"
                }
            },
            {
                date: new Date('2026-02-14'),
                name: "Valentine's Day",
                emoji: "‚ù§Ô∏è",
                instruction: "Collect all the love!",
                challenge: "finale",
                messages: {
                    collecting: "The whole week in one moment!",
                    success: "Love conquers all... challenges! ‚ù§Ô∏è"
                }
            }
        ];

        let gameState = {
            collected: JSON.parse(localStorage.getItem('valentineCollectedTest') || '[]'),
            currentChallenge: null
        };

        function saveProgress() {
            localStorage.setItem('valentineCollectedTest', JSON.stringify(gameState.collected));
        }

        function showMessage(text) {
            const messageEl = document.getElementById('message');
            if (messageEl) {
                messageEl.textContent = text;
                messageEl.className = 'message';
            }
        }

        function showSuccessMessage(text) {
            const messageEl = document.getElementById('message');
            if (messageEl) {
                messageEl.textContent = text;
                messageEl.className = 'message success-message';
            }
        }

        function createParticles(x, y) {
            const gameArea = document.getElementById('gameArea');
            const colors = ['#6b4c8a', '#8b7aa8', '#d4c5b9', '#f5f1e8', '#ffd700'];
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'confetti';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                const angle = (Math.PI * 2 * i) / 30;
                const velocity = 50 + Math.random() * 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                gameArea.appendChild(particle);
                particle.animate([
                    { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
                    { transform: 'translate(' + tx + 'px, ' + ty + 'px) rotate(' + (Math.random() * 720) + 'deg)', opacity: 0 }
                ], {
                    duration: 1000 + Math.random() * 500,
                    easing: 'cubic-bezier(0, .9, .57, 1)'
                }).onfinish = function() { particle.remove(); };
            }
        }

        function createHearts(x, y) {
            const gameArea = document.getElementById('gameArea');
            const hearts = ['üíú', 'üíó', 'üíñ', '‚ú®', 'üåü'];
            
            for (let i = 0; i < 15; i++) {
                const heart = document.createElement('div');
                heart.className = 'particle';
                heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.left = x + 'px';
                heart.style.top = y + 'px';
                gameArea.appendChild(heart);
                const tx = (Math.random() - 0.5) * 200;
                const ty = -100 - Math.random() * 100;
                heart.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: 'translate(' + tx + 'px, ' + ty + 'px) scale(0.5)', opacity: 0 }
                ], {
                    duration: 1500,
                    easing: 'ease-out'
                }).onfinish = function() { heart.remove(); };
            }
        }

        function collectSprite(dayIndex) {
            if (!gameState.collected.includes(dayIndex)) {
                gameState.collected.push(dayIndex);
                saveProgress();
                updateDayButtons();
            }
            
            const day = days[dayIndex];
            showSuccessMessage(day.messages.success);
            
            setTimeout(function() {
                const gameArea = document.getElementById('gameArea');
                gameArea.innerHTML = '<div class="instruction">Great job! üéâ</div><div class="message">Select another day to test more challenges!</div>';
            }, 3000);
        }


        function finalizeChallenge(dayIndex, html) {
                if (!gameState.collected.includes(dayIndex)) {
                    gameState.collected.push(dayIndex);
                    saveProgress();
                    updateDayButtons();
                }
                const gameArea = document.getElementById('gameArea');
                gameArea.innerHTML = html; // ‚úÖ persists
            }

        
        // Rose Day - Swipe to find the rose
function startColorChange(dayIndex) {
    const gameArea = document.getElementById('gameArea');
    const day = days[dayIndex];

    // Clean slate (prevents duplicate listeners on re-entry)
    gameArea.replaceWith(gameArea.cloneNode(false));
    const freshArea = document.getElementById('gameArea');

    let introStage = 0;

    freshArea.innerHTML =
        '<div class="instruction" id="instruction" style="font-size:1.8rem;margin-top:100px;">Happy Rose Day! üåπ</div>' +
        '<div class="message" id="message"></div>';

    function handleIntroTap() {
        introStage++;

        if (introStage === 1) {
            const inst = document.getElementById('instruction');
            inst.textContent = "But where's your rose?";
            inst.style.fontSize = '1.5rem';
            inst.style.marginTop = '0';
        } else if (introStage === 2) {
            freshArea.removeEventListener('click', handleIntroTap);
            startEmojiGame();
        }
    }

    freshArea.addEventListener('click', handleIntroTap);

    function startEmojiGame() {
        const emojis = [
            '‚òÄÔ∏è','üß∏','üêï','üåà','‚≠ê','üåª','üçÄ','üå∏','üê±','ü¶Å','üê∫','ü¶ä','üêª','üêº','üê®','üêØ',
            'ü¶Ö','ü¶â','üê¢','üê¨','üêã','üåç','üó∫Ô∏è','‚õ∞Ô∏è','üåã','üèîÔ∏è','üå≤','üå≥','üå¥','üåµ','üçÅ','üçÇ',
            'üåæ','üåø','‚òòÔ∏è','üíé','üî•','üíß','‚ùÑÔ∏è','‚ö°','üåô','‚òÅÔ∏è','üåä','üèµÔ∏è','üå∑','üåº','ü™ª','‚öì',
            'üß≠','‚ô†Ô∏è','‚ô£Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','‚òØÔ∏è','‚≠ï','‚ú≥Ô∏è','‚ùáÔ∏è','üî∂','üî∑'
        ];

        const totalEmojis = 240;
        let timerStarted = false;
        let timeLeft = 30;
        let timerInterval = null;
        let emojiElements = [];
        let roseMessageShown = false;
        let removedCount = 0;

        freshArea.innerHTML = '';
        freshArea.style.position = 'relative';
        freshArea.style.overflow = 'hidden';
        freshArea.style.touchAction = 'none';

        const header = document.createElement('div');
        header.style.cssText = 'position:relative;z-index:1001;padding:10px;text-align:center;';
        header.innerHTML =
            '<div class="instruction" id="instruction">But where\'s your rose?</div>' +
            '<div class="message" id="message"></div>';
        freshArea.appendChild(header);

        const emojiContainer = document.createElement('div');
        emojiContainer.id = 'emojiContainer';
        emojiContainer.style.cssText =
            'position:absolute;top:80px;left:0;right:0;bottom:0;overflow:hidden;';
        freshArea.appendChild(emojiContainer);

        const containerHeight = freshArea.offsetHeight - 80;
        const containerWidth = freshArea.offsetWidth;

        // Rose above everything & tappable
        const rose = document.createElement('div');
        rose.style.cssText =
            'position:absolute;font-size:4rem;z-index:9999;cursor:pointer;' +
            'transition:all 0.5s;pointer-events:auto;user-select:none;';
        rose.style.left = (20 + Math.random() * 50) + '%';
        rose.style.top = (20 + Math.random() * 50) + '%';
        rose.textContent = 'üåπ';
        emojiContainer.appendChild(rose);

        // Scatter emojis (swipe removes)
        for (let i = 0; i < totalEmojis; i++) {
            const emoji = document.createElement('div');
            const size = 1.5 + Math.random() * 1.5;
            emoji.style.cssText =
                'position:absolute;font-size:' + size + 'rem;' +
                'pointer-events:none;transition:all 0.4s ease-out;user-select:none;';
            emoji.style.left = (Math.random() * 85) + '%';
            emoji.style.top = (Math.random() * 85) + '%';
            emoji.style.zIndex = 10 + Math.floor(i / 20);
            emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            emojiContainer.appendChild(emoji);
            emojiElements.push(emoji);
        }

        emojiElements.sort(() => Math.random() - 0.5);

        function getRemovalCount() {
            const timeRatio = 1 - (timeLeft / 30);
            if (timeRatio < 0.3) return 1;
            if (timeRatio < 0.5) return Math.random() < 0.7 ? 1 : 2;
            if (timeRatio < 0.65) return 2 + Math.floor(Math.random() * 2);
            if (timeRatio < 0.8) return 5 + Math.floor(Math.random() * 3);
            return 12 + Math.floor(Math.random() * 8);
        }

        function checkAllEmojisGone() {
            for (let i = 0; i < emojiElements.length; i++) {
                if (emojiElements[i].style.opacity !== '0') return false;
            }
            return true;
        }

        function removeEmojis(x, y) {
            const count = getRemovalCount();
            let removed = 0;

            for (let i = 0; i < emojiElements.length && removed < count; i++) {
                const emoji = emojiElements[i];
                if (emoji.style.opacity !== '0') {
                    const rect = emoji.getBoundingClientRect();
                    const containerRect = emojiContainer.getBoundingClientRect();
                    const emojiX = rect.left - containerRect.left;
                    const emojiY = rect.top - containerRect.top;

                    const angle = Math.atan2(emojiY - y, emojiX - x);
                    const distance = 200 + Math.random() * 100;
                    const newX = Math.cos(angle) * distance;
                    const newY = Math.sin(angle) * distance;

                    emoji.style.transform =
                        'translate(' + newX + 'px, ' + newY + 'px) rotate(' + (Math.random() * 360) + 'deg)';
                    emoji.style.opacity = '0';
                    removed++;
                    removedCount++;
                }
            }

            if (removedCount >= totalEmojis - 10) {
                rose.style.transform = 'scale(1.3)';
                rose.style.filter = 'drop-shadow(0 0 15px #ff69b4)';
            }
        }

        let lastX = 0, lastY = 0;
        let isSwiping = false;

        function handleStart(e) {
            // If user starts on rose, don't hijack tap as swipe
            if (e.target === rose) return;

            e.preventDefault();
            const point = e.touches ? e.touches[0] : e;
            const containerRect = emojiContainer.getBoundingClientRect();
            lastX = point.clientX - containerRect.left;
            lastY = point.clientY - containerRect.top;
            isSwiping = true;

            if (!timerStarted) {
                timerStarted = true;
                timerInterval = setInterval(function () {
                    timeLeft--;

                    if (timeLeft <= 5 && removedCount < totalEmojis - 20) {
                        removeEmojis(containerWidth / 2, containerHeight / 2);
                    }

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        emojiElements.forEach(function (el) { el.style.opacity = '0'; });
                        rose.style.transform = 'scale(1.5)';
                        rose.style.filter = 'drop-shadow(0 0 20px #ff69b4)';
                    }
                }, 1000);
            }
        }

        function handleMove(e) {
            if (!isSwiping) return;
            e.preventDefault();
            const point = e.touches ? e.touches[0] : e;
            const containerRect = emojiContainer.getBoundingClientRect();
            const x = point.clientX - containerRect.left;
            const y = point.clientY - containerRect.top;

            const dist = Math.sqrt((x - lastX) ** 2 + (y - lastY) ** 2);
            if (dist > 15) {
                removeEmojis(x, y);
                lastX = x;
                lastY = y;
            }
        }

        function handleEnd() { isSwiping = false; }

        emojiContainer.addEventListener('mousedown', handleStart);
        emojiContainer.addEventListener('mousemove', handleMove);
        emojiContainer.addEventListener('mouseup', handleEnd);
        emojiContainer.addEventListener('mouseleave', handleEnd);
        emojiContainer.addEventListener('touchstart', handleStart, { passive: false });
        emojiContainer.addEventListener('touchmove', handleMove, { passive: false });
        emojiContainer.addEventListener('touchend', handleEnd);

        function endRoseDay(x, y) {
            if (timerInterval) clearInterval(timerInterval);

            // ‚úÖ Prevent overlap: remove emoji layer (including rose) BEFORE showing final text
            emojiContainer.remove();

            createHearts(x, y);
            createParticles(x, y);

            // ‚úÖ Show final message ONCE (top), no duplicate elsewhere
            const inst = document.getElementById('instruction');
            inst.textContent = 'Happy Rose Day babe! ‚ù§Ô∏è';
            inst.style.fontSize = '1.6rem';

            const msg = document.getElementById('message');
            if (msg) msg.textContent = '';

            // ‚úÖ Persistent end screen (after short celebratory pause)
            setTimeout(function () {
                finalizeChallenge(dayIndex,
                    '<div class="instruction" style="font-size:1.6rem;">Happy Rose Day babe! ‚ù§Ô∏è</div>' +
                    '<div class="message">Challenge cleared üåπ</div>'
                );
            }, 1200);
        }

        function tryCollectRose(ev) {
            ev.preventDefault?.();
            ev.stopPropagation();

            if (roseMessageShown) return;
            if (!checkAllEmojisGone()) return;

            roseMessageShown = true;

            const pt = ev.touches ? ev.touches[0] : (ev.changedTouches ? ev.changedTouches[0] : ev);
            endRoseDay(pt.clientX, pt.clientY);
        }

        rose.addEventListener('pointerup', tryCollectRose, { passive: false });
        rose.addEventListener('touchend', tryCollectRose, { passive: false });
    }
}
        // Propose Day - Shy guy proposes


function startRunAway(dayIndex) {
    const gameArea = document.getElementById('gameArea');
    const day = days[dayIndex];

    // Clean slate (prevents duplicate listeners on re-entry)
    gameArea.replaceWith(gameArea.cloneNode(false));
    const freshArea = document.getElementById('gameArea');

    freshArea.innerHTML = '<div class="instruction" id="instruction"></div><div class="message" id="message"></div>';

    let stage = 0;

    const guy = document.createElement('div');
    guy.className = 'sprite';
    guy.textContent = 'üôáüèΩ‚Äç‚ôÇÔ∏è';
    guy.style.left = '50%';
    guy.style.top = '50%';
    guy.style.transform = 'translate(-50%, -50%)';
    freshArea.appendChild(guy);

    const bubble = document.createElement('div');
    bubble.style.cssText =
        'position:absolute;background:white;padding:10px 15px;border-radius:15px;' +
        'box-shadow:0 2px 10px rgba(0,0,0,0.2);font-size:1.05rem;color:#6b4c8a;' +
        'opacity:0;transition:opacity 0.15s;z-index:100;max-width:70%;text-align:center;' +
        'pointer-events:none;';
    freshArea.appendChild(bubble);

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function showBubble(text, targetEl) {
        bubble.innerHTML = text;
        bubble.style.opacity = '1';

        // Place bubble close to emoji (above it), centered
        const guyRect = targetEl.getBoundingClientRect();
        const areaRect = freshArea.getBoundingClientRect();

        // Temporarily measure bubble size
        bubble.style.left = '0px';
        bubble.style.top = '0px';
        bubble.style.transform = 'translateX(-50%)';

        const bubbleRect = bubble.getBoundingClientRect();

        let centerX = (guyRect.left - areaRect.left) + (guyRect.width / 2);
        let topY = (guyRect.top - areaRect.top) - bubbleRect.height - 10;

        // If not enough space above, put it below
        if (topY < 10) {
            topY = (guyRect.bottom - areaRect.top) + 10;
        }

        // Clamp horizontally so it stays inside the area
        centerX = clamp(centerX, bubbleRect.width / 2 + 10, areaRect.width - bubbleRect.width / 2 - 10);

        bubble.style.left = centerX + 'px';
        bubble.style.top = topY + 'px';
    }

    function hideBubble() { bubble.style.opacity = '0'; }

    function moveGuyRandom() {
        const areaRect = freshArea.getBoundingClientRect();
        const newX = 50 + Math.random() * (areaRect.width - 150);
        const newY = 90 + Math.random() * (areaRect.height - 210);
        guy.style.left = newX + 'px';
        guy.style.top = newY + 'px';
        guy.style.transform = 'translate(0, 0)';
        // keep bubble near him if visible
        if (bubble.style.opacity === '1') showBubble(bubble.innerHTML, guy);
    }

    let chaseCount = 0;
    let tapCount = 0;

    // Stage 2: user taps empty area 3 times to bring him back
    freshArea.addEventListener('click', function (e) {
        if (e.target === freshArea && stage === 2) {
            tapCount++;
            if (tapCount >= 3) {
                stage = 3;
                tapCount = 0;
                guy.style.opacity = '1';
                moveGuyRandom();
            }
        }
    });

    function endProposeDay(x, y) {
        createHearts(x, y);
        createParticles(x, y);

        // ‚úÖ Show "Together forever" ONCE + add Happy Propose Day babe message
        const inst = document.getElementById('instruction');
        inst.innerHTML =
            '<div style="text-align:center; line-height:1.25;">' +
                '<div style="font-size:1.6rem; font-weight:bold;">Together forever! üíç</div>' +
                '<div style="font-size:1.25rem; margin-top:6px;">Happy Propose Day babe! ‚ù§Ô∏è</div>' +
                '<div style="font-size:1.25rem; margin-top:6px;">‚òÄÔ∏è‚òÄÔ∏èüåªüåª</div>' +
            '</div>';
        inst.style.fontSize = '1.4rem';

        const msg = document.getElementById('message');
        if (msg) msg.textContent = '';

        // ‚úÖ Persistent end screen (no collectSprite)
        setTimeout(function () {
            finalizeChallenge(dayIndex,
                '<div class="instruction" style="font-size:1.5rem; line-height:1.3;">' +
                    '<div style="font-weight:bold;">Together forever! üíç</div>' +
                    '<div style="margin-top:6px;">Happy Propose Day babe! ‚ù§Ô∏è</div>' +
                    '<div style="margin-top:6px;">‚òÄÔ∏è‚òÄÔ∏èüåªüåª</div>' +
                '</div>' +
                '<div class="message">Challenge cleared üíú</div>'
            );
        }, 1400);
    }

    guy.addEventListener('click', function (e) {
        e.stopPropagation();

        if (stage === 0) {
            showBubble('Hi', guy);
            stage = 1;
            setTimeout(function () {
                hideBubble();
                setTimeout(function () {
                    guy.style.opacity = '0';
                    stage = 2;
                }, 500);
            }, 1200);

        } else if (stage === 3) {
            showBubble('I was thinking....', guy);
            stage = 4;
            setTimeout(function () {
                hideBubble();
                setTimeout(function () {
                    guy.style.opacity = '0';
                    setTimeout(function () {
                        guy.style.opacity = '1';
                        moveGuyRandom();
                        stage = 5;
                    }, 700);
                }, 400);
            }, 1600);

        } else if (stage === 5) {
            chaseCount++;
            if (chaseCount < 5) {
                moveGuyRandom();
                guy.style.transition = 'all 0.25s ease';
            } else {
                stage = 6;
                guy.style.left = '50%';
                guy.style.top = '40%';
                guy.style.transform = 'translate(-50%, -50%)';
            }

        } else if (stage === 6) {
            showBubble('Be mine? üíï', guy);
            stage = 7;

            setTimeout(function () {
                const ring = document.createElement('div');
                ring.className = 'sprite';
                ring.textContent = 'üíç';
                ring.style.left = '70%';
                ring.style.top = '50%';
                ring.style.fontSize = '3rem';
                ring.style.animation = 'heartbeat 1s ease infinite';
                freshArea.appendChild(ring);

                ring.addEventListener('click', function (ev) {
                    ev.stopPropagation();
                    hideBubble();
                    guy.remove();
                    ring.remove();

                    const couple = document.createElement('div');
                    couple.className = 'sprite';
                    couple.textContent = 'üë´';
                    couple.style.left = '50%';
                    couple.style.top = '45%';
                    couple.style.transform = 'translate(-50%, -50%)';
                    couple.style.fontSize = '5rem';
                    freshArea.appendChild(couple);

                    endProposeDay(ev.clientX, ev.clientY);
                });
            }, 900);
        }
    });
}

        
        // Chocolate Day - Layered chocolate swipe reveal
        function startChocolateSwipe(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];

            const stage = document.createElement('div');
            stage.className = 'chocolate-stage';
            gameArea.appendChild(stage);

            const chocolate = document.createElement('div');
            chocolate.className = 'chocolate-target';
            chocolate.textContent = day.emoji;
            chocolate.style.display = 'none';
            stage.appendChild(chocolate);

            const layerPrompts = [day.messages.melting, day.messages.secondLayer, day.messages.finalLayer];
            const layers = [
                {
                    base: '#6a1b9a',
                    texture: function(ctx, w, h) {
                        const sheen = ctx.createLinearGradient(0, 0, w, h);
                        sheen.addColorStop(0, 'rgba(255, 255, 255, 0.28)');
                        sheen.addColorStop(0.4, 'rgba(255, 255, 255, 0.04)');
                        sheen.addColorStop(0.6, 'rgba(255, 255, 255, 0.22)');
                        sheen.addColorStop(1, 'rgba(255, 255, 255, 0.05)');
                        ctx.fillStyle = sheen;
                        ctx.fillRect(0, 0, w, h);
                    }
                },
                {
                    base: '#f9f9f6',
                    texture: function(ctx, w, h) {
                        ctx.strokeStyle = 'rgba(80, 80, 80, 0.12)';
                        ctx.lineWidth = 1;
                        for (let x = -h; x < w + h; x += 18) {
                            ctx.beginPath();
                            ctx.moveTo(x, 0);
                            ctx.lineTo(x + h, h);
                            ctx.stroke();
                        }
                    }
                },
                {
                    base: '#c9a53a',
                    texture: function(ctx, w, h) {
                        const foil = ctx.createLinearGradient(0, 0, w, 0);
                        foil.addColorStop(0, 'rgba(255, 255, 255, 0.14)');
                        foil.addColorStop(0.2, 'rgba(255, 255, 255, 0.35)');
                        foil.addColorStop(0.5, 'rgba(120, 84, 14, 0.22)');
                        foil.addColorStop(0.8, 'rgba(255, 255, 255, 0.28)');
                        foil.addColorStop(1, 'rgba(98, 68, 12, 0.2)');
                        ctx.fillStyle = foil;
                        ctx.fillRect(0, 0, w, h);

                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
                        for (let y = 0; y < h; y += 20) {
                            ctx.beginPath();
                            ctx.moveTo(0, y + Math.random() * 6);
                            ctx.lineTo(w, y + Math.random() * 6);
                            ctx.stroke();
                        }
                    }
                }
            ];

            let currentLayerIndex = 0;
            let activeLayer = createChocolateLayer(stage, layers[currentLayerIndex]);
            showMessage(day.messages.melting);

            function advanceLayer() {
                activeLayer.canvas.remove();
                currentLayerIndex += 1;

                if (currentLayerIndex < layers.length) {
                    showMessage(layerPrompts[currentLayerIndex]);
                    activeLayer = createChocolateLayer(stage, layers[currentLayerIndex]);
                    return;
                }

                showMessage(day.messages.tapChocolate);
                chocolate.style.display = 'block';
                chocolate.addEventListener('click', function(event) {
                    createParticles(event.clientX, event.clientY);
                    collectSprite(dayIndex);
                }, { once: true });
            }

            function bindScratchEvents(layerState) {
                function drawAt(clientX, clientY) {
                    const rect = layerState.canvas.getBoundingClientRect();
                    const scaleX = layerState.canvas.width / rect.width;
                    const scaleY = layerState.canvas.height / rect.height;
                    const x = (clientX - rect.left) * scaleX;
                    const y = (clientY - rect.top) * scaleY;

                    layerState.ctx.globalCompositeOperation = 'destination-out';
                    layerState.ctx.beginPath();
                    layerState.ctx.arc(x, y, 30, 0, Math.PI * 2);
                    layerState.ctx.fill();

                    if (!layerState.completed && layerState.getClearedRatio() > 0.96) {
                        layerState.completed = true;
                        advanceLayer();
                    }
                }

                layerState.canvas.addEventListener('pointerdown', function(event) {
                    layerState.isDrawing = true;
                    drawAt(event.clientX, event.clientY);
                });

                layerState.canvas.addEventListener('pointermove', function(event) {
                    if (!layerState.isDrawing) {
                        return;
                    }
                    drawAt(event.clientX, event.clientY);
                });

                window.addEventListener('pointerup', function() {
                    layerState.isDrawing = false;
                }, { once: false });
            }

            function createChocolateLayer(parent, styleConfig) {
                const rect = parent.getBoundingClientRect();
                const pixelRatio = window.devicePixelRatio || 1;
                const canvas = document.createElement('canvas');
                canvas.className = 'chocolate-layer';
                canvas.width = Math.floor(rect.width * pixelRatio);
                canvas.height = Math.floor(rect.height * pixelRatio);
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                const ctx = canvas.getContext('2d');

                ctx.scale(pixelRatio, pixelRatio);
                ctx.fillStyle = styleConfig.base;
                ctx.fillRect(0, 0, rect.width, rect.height);
                styleConfig.texture(ctx, rect.width, rect.height);

                parent.appendChild(canvas);

                const layerState = {
                    canvas: canvas,
                    ctx: ctx,
                    isDrawing: false,
                    completed: false,
                    getClearedRatio: function() {
                        const sampleCtx = canvas.getContext('2d', { willReadFrequently: true });
                        const image = sampleCtx.getImageData(0, 0, canvas.width, canvas.height).data;
                        let transparentPixels = 0;
                        for (let i = 3; i < image.length; i += 4) {
                            if (image[i] < 16) {
                                transparentPixels += 1;
                            }
                        }
                        return transparentPixels / (canvas.width * canvas.height);
                    }
                };

                bindScratchEvents(layerState);
                return layerState;
            }
        }

        // Teddy Day - Peekaboo
        function startPeekaboo(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];
            
            const sprite = document.createElement('div');
            sprite.className = 'sprite';
            sprite.textContent = day.emoji;
            sprite.style.left = '50%';
            sprite.style.top = '50%';
            sprite.style.transform = 'translate(-50%, -50%)';
            sprite.style.opacity = '0';
            gameArea.appendChild(sprite);
            
            showMessage(day.messages.hiding);
            
            const peekInterval = setInterval(function() {
                sprite.style.opacity = '1';
                setTimeout(function() {
                    sprite.style.opacity = '0';
                }, 1000);
            }, 2000);
            
            sprite.addEventListener('click', function(e) {
                if (sprite.style.opacity === '1') {
                    clearInterval(peekInterval);
                    sprite.style.opacity = '1';
                    createHearts(e.clientX, e.clientY);
                    sprite.style.animation = 'bounce 0.5s ease';
                    setTimeout(function() {
                        sprite.remove();
                        collectSprite(dayIndex);
                    }, 500);
                }
            });
        }

        // Promise Day - Three taps
        function startThreeTaps(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];
            
            const sprite = document.createElement('div');
            sprite.className = 'sprite';
            sprite.textContent = day.emoji;
            sprite.style.left = '50%';
            sprite.style.top = '50%';
            sprite.style.transform = 'translate(-50%, -50%)';
            gameArea.appendChild(sprite);
            
            let tapCount = 0;
            const messages = [day.messages.first, day.messages.second, day.messages.third];
            showMessage(messages[0]);
            
            sprite.addEventListener('click', function(e) {
                tapCount++;
                sprite.style.transform = 'translate(-50%, -50%) scale(1.2)';
                setTimeout(function() {
                    sprite.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 200);
                
                if (tapCount < 3) {
                    showMessage(messages[tapCount]);
                    createParticles(e.clientX, e.clientY);
                } else {
                    createHearts(e.clientX, e.clientY);
                    sprite.style.animation = 'heartbeat 0.5s ease';
                    setTimeout(function() {
                        sprite.remove();
                        collectSprite(dayIndex);
                    }, 500);
                }
            });
        }

        // Hug Day - Tap both hearts
        function startSimultaneous(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];
            
            const heart1 = document.createElement('div');
            heart1.className = 'sprite';
            heart1.textContent = 'üíú';
            heart1.style.left = '20%';
            heart1.style.top = '50%';
            
            const heart2 = document.createElement('div');
            heart2.className = 'sprite';
            heart2.textContent = 'üíó';
            heart2.style.left = '80%';
            heart2.style.top = '50%';
            
            gameArea.appendChild(heart1);
            gameArea.appendChild(heart2);
            
            showMessage(day.messages.waiting);
            
            let tapped = { heart1: false, heart2: false };
            let lastTapTime = 0;
            
            function handleTap(heartName, e) {
                tapped[heartName] = true;
                lastTapTime = Date.now();
                
                setTimeout(function() {
                    if (Date.now() - lastTapTime > 500) {
                        tapped = { heart1: false, heart2: false };
                    }
                }, 500);
                
                if (tapped.heart1 && tapped.heart2) {
                    createHearts(e.clientX, e.clientY);
                    heart1.style.animation = 'float 0.8s ease';
                    heart2.style.animation = 'float 0.8s ease';
                    
                    setTimeout(function() {
                        heart1.remove();
                        heart2.remove();
                        collectSprite(dayIndex);
                    }, 800);
                } else {
                    showMessage(day.messages.miss);
                }
            }
            
            heart1.addEventListener('click', function(e) { handleTap('heart1', e); });
            heart2.addEventListener('click', function(e) { handleTap('heart2', e); });
        }

        // Kiss Day - Catch fleeting kiss
        function startFleeting(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];
            const rect = gameArea.getBoundingClientRect();
            
            let attempts = 0;
            
            function spawnKiss() {
                const sprite = document.createElement('div');
                sprite.className = 'sprite';
                sprite.textContent = day.emoji;
                sprite.style.left = Math.random() * (rect.width - 80) + 'px';
                sprite.style.top = Math.random() * (rect.height - 80) + 'px';
                sprite.style.opacity = '0';
                gameArea.appendChild(sprite);
                
                setTimeout(function() {
                    sprite.style.opacity = '1';
                    sprite.style.transition = 'opacity 0.3s';
                }, 100);
                
                showMessage(day.messages.appearing);
                
                const disappear = setTimeout(function() {
                    sprite.style.opacity = '0';
                    setTimeout(function() {
                        sprite.remove();
                        attempts++;
                        showMessage(day.messages.miss);
                        setTimeout(spawnKiss, 1000);
                    }, 300);
                }, 1500);
                
                sprite.addEventListener('click', function(e) {
                    clearTimeout(disappear);
                    sprite.style.opacity = '1';
                    createParticles(e.clientX, e.clientY);
                    sprite.style.animation = 'spin 0.5s ease';
                    setTimeout(function() {
                        sprite.remove();
                        collectSprite(dayIndex);
                    }, 500);
                });
            }
            
            spawnKiss();
        }

        // Valentine's Day - Collect all emojis
        function startFinale(dayIndex) {
            const gameArea = document.getElementById('gameArea');
            const day = days[dayIndex];
            
            showMessage(day.messages.collecting);
            
            const allEmojis = days.map(function(d) { return d.emoji; });
            let collected = 0;
            
            allEmojis.forEach(function(emoji, index) {
                setTimeout(function() {
                    const sprite = document.createElement('div');
                    sprite.className = 'sprite';
                    sprite.textContent = emoji;
                    const angle = (Math.PI * 2 * index) / allEmojis.length;
                    sprite.style.left = (50 + Math.cos(angle) * 30) + '%';
                    sprite.style.top = (50 + Math.sin(angle) * 30) + '%';
                    sprite.style.animation = 'float 2s ease-in-out infinite';
                    sprite.style.animationDelay = (index * 0.1) + 's';
                    gameArea.appendChild(sprite);
                    
                    sprite.addEventListener('click', function(e) {
                        collected++;
                        createParticles(e.clientX, e.clientY);
                        sprite.remove();
                        if (collected === allEmojis.length) {
                            setTimeout(function() {
                                collectSprite(dayIndex);
                            }, 500);
                        }
                    });
                }, index * 200);
            });
        }

        function startChallenge(dayIndex) {
            const day = days[dayIndex];
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = '<div class="instruction" id="instruction">' + day.instruction + '</div><div class="message" id="message"></div>';
            
            switch (day.challenge) {
                case 'colorChange': startColorChange(dayIndex); break;
                case 'runAway': startRunAway(dayIndex); break;
                case 'chocolateSwipe': startChocolateSwipe(dayIndex); break;
                case 'peekaboo': startPeekaboo(dayIndex); break;
                case 'threeTaps': startThreeTaps(dayIndex); break;
                case 'simultaneous': startSimultaneous(dayIndex); break;
                case 'fleeting': startFleeting(dayIndex); break;
                case 'finale': startFinale(dayIndex); break;
            }
        }

        function updateDayButtons() {
            const container = document.getElementById('dayButtons');
            container.innerHTML = '';
            days.forEach(function(day, index) {
                const button = document.createElement('button');
                button.className = 'day-button';
                if (gameState.collected.includes(index)) {
                    button.classList.add('collected');
                }
                button.textContent = day.emoji + ' ' + day.name;
                button.onclick = function() { startChallenge(index); };
                container.appendChild(button);
            });
        }

        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress?')) {
                gameState.collected = [];
                saveProgress();
                updateDayButtons();
                document.getElementById('gameArea').innerHTML = '<div class="instruction">Progress reset! Select a day above to test.</div>';
            }
        }

        function init() {
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            updateDayButtons();
        }

        init();
    </script>
</body>
</html>
